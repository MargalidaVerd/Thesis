<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Margalida Verd Julià">

<title>TFG</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="TFG_files/libs/clipboard/clipboard.min.js"></script>
<script src="TFG_files/libs/quarto-html/quarto.js"></script>
<script src="TFG_files/libs/quarto-html/popper.min.js"></script>
<script src="TFG_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="TFG_files/libs/quarto-html/anchor.min.js"></script>
<link href="TFG_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="TFG_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="TFG_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="TFG_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="TFG_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#installing-data-and-packages" id="toc-installing-data-and-packages" class="nav-link active" data-scroll-target="#installing-data-and-packages"><span class="header-section-number">1</span> Installing data and packages</a></li>
  <li><a href="#cleaning-data" id="toc-cleaning-data" class="nav-link" data-scroll-target="#cleaning-data"><span class="header-section-number">2</span> Cleaning data</a></li>
  <li><a href="#chosen-countries" id="toc-chosen-countries" class="nav-link" data-scroll-target="#chosen-countries"><span class="header-section-number">3</span> Chosen countries</a></li>
  <li><a href="#data-partitioning-utilities" id="toc-data-partitioning-utilities" class="nav-link" data-scroll-target="#data-partitioning-utilities"><span class="header-section-number">4</span> Data partitioning utilities</a></li>
  <li><a href="#arima-model-utilities" id="toc-arima-model-utilities" class="nav-link" data-scroll-target="#arima-model-utilities"><span class="header-section-number">5</span> ARIMA model utilities</a></li>
  <li><a href="#arima-models" id="toc-arima-models" class="nav-link" data-scroll-target="#arima-models"><span class="header-section-number">6</span> ARIMA models</a>
  <ul class="collapse">
  <li><a href="#spain" id="toc-spain" class="nav-link" data-scroll-target="#spain"><span class="header-section-number">6.1</span> Spain</a></li>
  <li><a href="#the-netherlands" id="toc-the-netherlands" class="nav-link" data-scroll-target="#the-netherlands"><span class="header-section-number">6.2</span> The Netherlands</a></li>
  <li><a href="#switzerland" id="toc-switzerland" class="nav-link" data-scroll-target="#switzerland"><span class="header-section-number">6.3</span> Switzerland</a></li>
  <li><a href="#sweden" id="toc-sweden" class="nav-link" data-scroll-target="#sweden"><span class="header-section-number">6.4</span> Sweden</a></li>
  <li><a href="#bulgaria" id="toc-bulgaria" class="nav-link" data-scroll-target="#bulgaria"><span class="header-section-number">6.5</span> Bulgaria</a></li>
  <li><a href="#estonia" id="toc-estonia" class="nav-link" data-scroll-target="#estonia"><span class="header-section-number">6.6</span> Estonia</a></li>
  </ul></li>
  <li><a href="#arimax-models" id="toc-arimax-models" class="nav-link" data-scroll-target="#arimax-models"><span class="header-section-number">7</span> ARIMAX models</a>
  <ul class="collapse">
  <li><a href="#spain-1" id="toc-spain-1" class="nav-link" data-scroll-target="#spain-1"><span class="header-section-number">7.1</span> Spain</a></li>
  <li><a href="#the-netherlands-1" id="toc-the-netherlands-1" class="nav-link" data-scroll-target="#the-netherlands-1"><span class="header-section-number">7.2</span> The Netherlands</a></li>
  <li><a href="#bulgaria-1" id="toc-bulgaria-1" class="nav-link" data-scroll-target="#bulgaria-1"><span class="header-section-number">7.3</span> Bulgaria</a></li>
  <li><a href="#estonia-1" id="toc-estonia-1" class="nav-link" data-scroll-target="#estonia-1"><span class="header-section-number">7.4</span> Estonia</a></li>
  <li><a href="#sweden-1" id="toc-sweden-1" class="nav-link" data-scroll-target="#sweden-1"><span class="header-section-number">7.5</span> Sweden</a></li>
  <li><a href="#switzerland-1" id="toc-switzerland-1" class="nav-link" data-scroll-target="#switzerland-1"><span class="header-section-number">7.6</span> Switzerland</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="TFG.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">TFG</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Margalida Verd Julià </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="installing-data-and-packages" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="installing-data-and-packages"><span class="header-section-number">1</span> Installing data and packages</h2>
<p>First, we will install and load the necessary packages for this study. Additionally, we will load the required datasets. The analysis is based on three datasets:</p>
<ul>
<li><p><strong>Mortality</strong>: Downloaded from the World Health Organization, this is the primary dataset for the analysis. It contains the number of tuberculosis-related deaths in all countries. However, our study will focus solely on European countries.</p></li>
<li><p><strong>Population</strong>: From this dataset, we will extract only the population variable. The source of this data is <em>Our World in Data</em>.</p></li>
<li><p><strong>GDP per capita</strong>: Similar to the population dataset, we will extract only the <em>gdp_per_capita</em> variable. The source of this data is <em>Data Bank</em>.</p></li>
</ul>
<p>Let’s examine the structure of the datasets:</p>
<ol type="1">
<li>Mortality:</li>
</ol>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 14,692
Columns: 12
$ Region.Code                                                 &lt;chr&gt; "EU", "EU"…
$ Region.Name                                                 &lt;chr&gt; "Europe", …
$ Country.Code                                                &lt;chr&gt; "ALB", "AL…
$ Country.Name                                                &lt;chr&gt; "Albania",…
$ Year                                                        &lt;dbl&gt; 1987, 1997…
$ Sex                                                         &lt;chr&gt; "All", "Al…
$ Age.group.code                                              &lt;chr&gt; "Age_all",…
$ Age.Group                                                   &lt;chr&gt; "[All]", "…
$ Number                                                      &lt;dbl&gt; 47, 19, 10…
$ Percentage.of.cause.specific.deaths.out.of.total.deaths     &lt;dbl&gt; 0.27126861…
$ Age.standardized.death.rate.per.100.000.standard.population &lt;dbl&gt; 2.2548644,…
$ Death.rate.per.100.000.population                           &lt;dbl&gt; 1.5279087,…</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Age_all"</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Population</li>
</ol>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 18,944
Columns: 3
$ Entity                                                &lt;chr&gt; "Afghanistan", "…
$ Year                                                  &lt;int&gt; 1950, 1951, 1952…
$ Population...Sex..all...Age..all...Variant..estimates &lt;dbl&gt; 7776182, 7879343…</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>gdp_per_capita</li>
</ol>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 2,629
Columns: 7
$ Series.Name  &lt;chr&gt; "GDP per capita (current US$)", "GDP per capita (current …
$ Series.Code  &lt;chr&gt; "NY.GDP.PCAP.CD", "NY.GDP.PCAP.CD", "NY.GDP.PCAP.CD", "NY…
$ Country.Name &lt;chr&gt; "Albania", "Albania", "Albania", "Albania", "Albania", "A…
$ Country.Code &lt;chr&gt; "ALB", "ALB", "ALB", "ALB", "ALB", "ALB", "ALB", "ALB", "…
$ Time         &lt;int&gt; 1960, 1961, 1962, 1963, 1964, 1965, 1966, 1967, 1968, 196…
$ Time.Code    &lt;chr&gt; "YR1960", "YR1961", "YR1962", "YR1963", "YR1964", "YR1965…
$ Value        &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</code></pre>
</div>
</div>
</section>
<section id="cleaning-data" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="cleaning-data"><span class="header-section-number">2</span> Cleaning data</h2>
<p>As seen, we need to standardize the variables names to merge the tables.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Mortality"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 14,692
Columns: 12
$ region_code                       &lt;chr&gt; "EU", "EU", "EU", "EU", "EU", "EU", …
$ region_name                       &lt;chr&gt; "Europe", "Europe", "Europe", "Europ…
$ country_code                      &lt;chr&gt; "ALB", "ALB", "ALB", "ALB", "ALB", "…
$ country_name                      &lt;chr&gt; "Albania", "Albania", "Albania", "Al…
$ year                              &lt;dbl&gt; 1987, 1997, 1996, 1996, 1995, 1994, …
$ Sex                               &lt;chr&gt; "All", "All", "Female", "All", "Male…
$ Age.group.code                    &lt;chr&gt; "Age_all", "Age_all", "Age_all", "Ag…
$ Age.Group                         &lt;chr&gt; "[All]", "[All]", "[All]", "[All]", …
$ number_deaths                     &lt;dbl&gt; 47, 19, 10, 34, 10, 13, 26, 39, 12, …
$ percent_cause_specific_death_rate &lt;dbl&gt; 0.27126861, 0.11741441, 0.14432097, …
$ age_death_rate                    &lt;dbl&gt; 2.2548644, 0.8057827, 0.7155687, 1.1…
$ death_rate                        &lt;dbl&gt; 1.5279087, 0.5715489, 0.6027727, 1.0…</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Population"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 18,944
Columns: 3
$ country_name &lt;chr&gt; "Afghanistan", "Afghanistan", "Afghanistan", "Afghanistan…
$ year         &lt;int&gt; 1950, 1951, 1952, 1953, 1954, 1955, 1956, 1957, 1958, 195…
$ population   &lt;dbl&gt; 7776182, 7879343, 7987783, 8096703, 8207953, 8326981, 845…</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "gdp_per_capita"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 2,629
Columns: 4
$ country_name &lt;chr&gt; "Albania", "Albania", "Albania", "Albania", "Albania", "A…
$ country_code &lt;chr&gt; "ALB", "ALB", "ALB", "ALB", "ALB", "ALB", "ALB", "ALB", "…
$ year         &lt;int&gt; 1960, 1961, 1962, 1963, 1964, 1965, 1966, 1967, 1968, 196…
$ gdp_capita   &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</code></pre>
</div>
</div>
<p>The next step is to select the study variables from the mortality dataset. We will exclude <code>Sex</code>, <code>Age.group.code</code> and <code>Age.group</code>.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,869
Columns: 9
$ region_code                       &lt;chr&gt; "EU", "EU", "EU", "EU", "EU", "EU", …
$ region_name                       &lt;chr&gt; "Europe", "Europe", "Europe", "Europ…
$ country_code                      &lt;chr&gt; "ALB", "ALB", "ALB", "ALB", "ALB", "…
$ country_name                      &lt;chr&gt; "Albania", "Albania", "Albania", "Al…
$ year                              &lt;dbl&gt; 1987, 1997, 1996, 1994, 1992, 1989, …
$ number_deaths                     &lt;dbl&gt; 47, 19, 34, 39, 22, 41, 39, 17, 34, …
$ percent_cause_specific_death_rate &lt;dbl&gt; 0.27126861, 0.11741441, 0.20302144, …
$ age_death_rate                    &lt;dbl&gt; 2.2548644, 0.8057827, 1.1585865, 1.5…
$ death_rate                        &lt;dbl&gt; 1.5279087, 0.5715489, 1.0356381, 1.2…</code></pre>
</div>
</div>
<p>Now, we can merge the remaining two datasets.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,998
Columns: 11
$ region_code                       &lt;chr&gt; "EU", "EU", "EU", "EU", "EU", "EU", …
$ region_name                       &lt;chr&gt; "Europe", "Europe", "Europe", "Europ…
$ country_code                      &lt;chr&gt; "ALB", "ALB", "ALB", "ALB", "ALB", "…
$ country_name                      &lt;chr&gt; "Albania", "Albania", "Albania", "Al…
$ year                              &lt;dbl&gt; 1987, 1997, 1996, 1994, 1992, 1989, …
$ number_deaths                     &lt;dbl&gt; 47, 19, 34, 39, 22, 41, 39, 17, 34, …
$ percent_cause_specific_death_rate &lt;dbl&gt; 0.27126861, 0.11741441, 0.20302144, …
$ age_death_rate                    &lt;dbl&gt; 2.2548644, 0.8057827, 1.1585865, 1.5…
$ death_rate                        &lt;dbl&gt; 1.5279087, 0.5715489, 1.0356381, 1.2…
$ population                        &lt;dbl&gt; 3148843, 3229665, 3245681, 3269417, …
$ gdp_capita                        &lt;dbl&gt; 674.7934, 717.3800, 1009.9771, 586.4…</code></pre>
</div>
</div>
</section>
<section id="chosen-countries" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="chosen-countries"><span class="header-section-number">3</span> Chosen countries</h2>
<p>First, we will define the criteria for dividing European countries into six distinct regions: North, South, West, East, Central, and the Balkans. The Balkans have been designated as a separate region due to their significant cultural differences from neighboring countries. We will add a new variable to the dataset that specifies the subregion to which each country belongs.</p>
<p>The map below shows the division that would be used from this point forward.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We are considering Greece as part of the Southern region due to the cultural differences with the Balkan countries. Now, we would choose a country to represent each European subregion. We will select five European countries to analyze their trends in the number of tuberculosis-related deaths. The selection criteria will ensure that the chosen countries represent different regions of Europe (e.g., North, South, etc.) while also having a sufficient number of time observations to construct a reliable time series. Additionally, we aim to include countries that exhibit distinct trends in tuberculosis mortality, making the study more insightful by allowing for a comparative analysis and accurate forecasting of different patterns.</p>
<p>As a first step, we will address any missing values (NA) in the dataset for the variable Number_Deaths in each selected country. We are going to choose countries that at least have 40 years with data.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>                                           country_name  n
1                                           Netherlands 73
2                                               Iceland 72
3                                                Sweden 72
4                                               Denmark 71
5                                                France 71
6                                               Ireland 71
7                                                 Spain 71
8                                           Switzerland 71
9  United Kingdom of Great Britain and Northern Ireland 71
10                                              Finland 70
11                                                Italy 70
12                                              Hungary 68
13                                              Austria 67
14                                              Belgium 67
15                                               Norway 66
16                                             Portugal 62
17                                               Poland 61
18                                               Greece 60
19                                              Romania 60
20                                             Bulgaria 58
21                                           Luxembourg 56
22                                                Malta 55
23                                               Latvia 42
24                                              Estonia 40
25                                            Lithuania 40
26                                   Russian Federation 40</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>full_dataset <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(subregion <span class="sc">==</span> <span class="st">"C"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(country_name) <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">number_deaths =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(number_deaths)),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">population  =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(population)),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">gdp_capita  =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(gdp_capita))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(number_deaths)) <span class="sc">%&gt;%</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  country_name number_deaths population gdp_capita
1  Switzerland            71         71         62
2      Hungary            68         68         55
3      Austria            67         67         62
4       Poland            61         61         30
5   Luxembourg            56         56         56
6      Czechia            36         36         32
7      Germany            31         31         31
8     Slovakia            28         28         28</code></pre>
</div>
</div>
<p>Lets study each subregion:</p>
<ul>
<li><p><strong>Southern Europe</strong>. Due to the geographical origin of the authors, we will choose Spain as the representative country of this region.</p></li>
<li><p><strong>Northern Europe</strong>. We observe that Iceland has 72 out of 74 years with recorded values for the selected variable, making it a suitable choice to represent the North region of Europe.</p></li>
<li><p><strong>Western Europe</strong>. As Netherlands is the country with a greatest number of values, it would be our choice for this specific region.</p></li>
<li><p><strong>Eastern Europe</strong>. It is noticeable that eastern countries are the ones with a less number of recorded values (most of them have only 40 or less); then, it would be a special region to analyse. Lithuania will represent the Northeast region, with 40 recorded values. Even though there are nearby countries with longer recorded periods, the tendency of Lithuania stands out among the rest, which will make for an interesting analysis.</p></li>
<li><p><strong>Central Europe</strong>. Switzerland will be the representative country of the central region. It has 71 recorded values, that will fit perfectly when modeling the time series.</p></li>
<li><p><strong>Balkans region</strong>. For the Balkans region, we have selected Romania, which has 60 recorded values. It will be an interesting case of analysis due to its tendency, that is a bit different as the other countries.</p></li>
</ul>
<p>The selection criteria prioritize minimizing the number of missing values (NA) while ensuring a diverse representation of different regions in Europe. As we have discussed trends, let’s display the trend in tuberculosis-related deaths for the selected countries.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="data-partitioning-utilities" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="data-partitioning-utilities"><span class="header-section-number">4</span> Data partitioning utilities</h2>
<p>To standardize the modeling process across multiple countries, we define helper structures that facilitate consistent data handling. Specifically, we construct a country_splits hashmap to store the full, training, and testing datasets for each selected country.</p>
<p>The first step is to initialize this structure with the full dataset filtered by country and ordered by year:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>country_splits <span class="ot">&lt;-</span> <span class="fu">hashmap</span>()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>chosen_countries <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Spain"</span>, <span class="st">"Netherlands"</span>, <span class="st">"Sweden"</span>, <span class="st">"Switzerland"</span>, <span class="st">"Bulgaria"</span>, <span class="st">"Estonia"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name <span class="cf">in</span> chosen_countries) {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  country_splits[[name]][[<span class="st">"full"</span>]] <span class="ot">&lt;-</span> full_dataset <span class="sc">%&gt;%</span> <span class="fu">filter</span>(country_name <span class="sc">==</span> name) <span class="sc">%&gt;%</span>  <span class="fu">arrange</span>(year)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we define the specific number of years to allocate to the testing set for each country. These values were chosen based on the total number of available observations, ensuring approximately 15–20% of the series is reserved for out-of-sample evaluation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>test_lengths_per_country <span class="ot">=</span> <span class="fu">hashmap</span>()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>test_lengths_per_country[[<span class="st">"Spain"</span>]] <span class="ot">=</span> <span class="dv">11</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>test_lengths_per_country[[<span class="st">"Switzerland"</span>]] <span class="ot">=</span> <span class="dv">11</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>test_lengths_per_country[[<span class="st">"Sweden"</span>]] <span class="ot">=</span> <span class="dv">11</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>test_lengths_per_country[[<span class="st">"Estonia"</span>]] <span class="ot">=</span> <span class="dv">11</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>test_lengths_per_country[[<span class="st">"Netherlands"</span>]] <span class="ot">=</span> <span class="dv">12</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>test_lengths_per_country[[<span class="st">"Bulgaria"</span>]] <span class="ot">=</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we split the dataset for each country into a training and a testing subset based on the predefined test lengths. This setup is essential for subsequent model fitting and forecast evaluation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (country <span class="cf">in</span> chosen_countries) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  country_dataset <span class="ot">=</span> country_splits[[country]]<span class="sc">$</span>full</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  total_len <span class="ot">=</span> <span class="fu">nrow</span>(country_dataset)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  test_len <span class="ot">=</span> test_lengths_per_country[[country]]</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  country_splits[[country]][[<span class="st">"train"</span>]] <span class="ot">=</span> country_dataset[<span class="dv">1</span><span class="sc">:</span>(total_len <span class="sc">-</span> test_len ),]</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  country_splits[[country]][[<span class="st">"test"</span>]] <span class="ot">=</span> country_dataset[(total_len <span class="sc">-</span> test_len <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>total_len,]</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="arima-model-utilities" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="arima-model-utilities"><span class="header-section-number">5</span> ARIMA model utilities</h2>
<p>In this section are presented the different methods for the ARIMA forecast. First of all, new functions to plot the ACF and PACF of the time series are defined, in order to get more visible plots (following the schema of python’s library matplt.lib).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>custom_acf_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(ts_data, <span class="at">max_lag =</span> <span class="dv">25</span>) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  acf_vals <span class="ot">&lt;-</span> <span class="fu">acf</span>(ts_data, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  acf_df <span class="ot">&lt;-</span> <span class="fu">with</span>(acf_vals, <span class="fu">data.frame</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lag =</span> lag,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">ACF_value =</span> acf</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(ts_data))</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  acf_df<span class="sc">$</span>UCL <span class="ot">&lt;-</span> conf</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  acf_df<span class="sc">$</span>LCL <span class="ot">&lt;-</span> <span class="sc">-</span>conf</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(acf_df, <span class="fu">aes</span>(<span class="at">x =</span> Lag, <span class="at">y =</span> ACF_value)) <span class="sc">+</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"#1f77b4"</span>) <span class="sc">+</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> LCL, <span class="at">ymax =</span> UCL), <span class="at">fill =</span> <span class="st">"#1f77b4"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> Lag, <span class="at">yend =</span> <span class="dv">0</span>), <span class="at">color =</span> <span class="st">"#1f77b4"</span>) <span class="sc">+</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"#1f77b4"</span>) <span class="sc">+</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">1.01</span>)) <span class="sc">+</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">1.01</span>, <span class="at">by =</span> <span class="fl">0.25</span>)) <span class="sc">+</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_lag, <span class="at">by =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">""</span>, <span class="at">x =</span> <span class="st">"Lag"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>custom_pacf_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(ts_data, <span class="at">max_lag =</span> <span class="dv">25</span>) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  pacf_vals <span class="ot">&lt;-</span> <span class="fu">pacf</span>(ts_data, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  pacf_df <span class="ot">&lt;-</span> <span class="fu">with</span>(pacf_vals, <span class="fu">data.frame</span>(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lag =</span> lag,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">PACF_value =</span> acf</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(ts_data))</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  pacf_df<span class="sc">$</span>UCL <span class="ot">&lt;-</span> conf</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  pacf_df<span class="sc">$</span>LCL <span class="ot">&lt;-</span> <span class="sc">-</span>conf</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(pacf_df, <span class="fu">aes</span>(<span class="at">x =</span> Lag, <span class="at">y =</span> PACF_value)) <span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"#1f77b4"</span>) <span class="sc">+</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> LCL, <span class="at">ymax =</span> UCL), <span class="at">fill =</span> <span class="st">"#1f77b4"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> Lag, <span class="at">yend =</span> <span class="dv">0</span>), <span class="at">color =</span> <span class="st">"#1f77b4"</span>) <span class="sc">+</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"#1f77b4"</span>) <span class="sc">+</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">1.01</span>)) <span class="sc">+</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">1.01</span>, <span class="at">by =</span> <span class="fl">0.25</span>)) <span class="sc">+</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, max_lag, <span class="at">by =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">""</span>, <span class="at">x =</span> <span class="st">"Lag"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, a function to automate the selection of ARIMA models is created. This function systematically evaluates various parameter combinations and reports their corresponding Akaike Information Criterion (AIC) values. This approach allows for an informed and reproducible model selection process, particularly useful when the number of possible <span class="math inline">\((p,d,q)\)</span> combinations is large and exhaustive testing is impractical.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>try_all_arima <span class="ot">&lt;-</span> <span class="cf">function</span>(ar_coef, d_coef, ma_coef, time_series) {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (p <span class="cf">in</span> ar_coef) {</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(d <span class="cf">in</span> d_coef) {</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (q <span class="cf">in</span> ma_coef) {</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        arima_fit <span class="ot">&lt;-</span> <span class="fu">Arima</span>(time_series, <span class="at">order =</span> <span class="fu">c</span>(p, d, q))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"ARIMA("</span>, p, <span class="st">","</span>, d,<span class="st">","</span> ,q, <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(arima_fit<span class="sc">$</span>coef)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"AIC:"</span>, <span class="fu">AIC</span>(arima_fit), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function iterates over all specified combinations of autoregressive, differencing, and moving average orders. For each configuration, it fits an ARIMA model and outputs the estimated parameters along with the AIC value, which serves as the model selection criterion.</p>
<p>Next, we define the get_length function to facilitate quick retrieval of the number of non-missing observations in a specified dataset. Accessing time series lengths manually for each country and subset (full, train, or test) can be cumbersome and error-prone. This utility function simplifies the process by requiring only the country name, the desired subset, and the target variable. It returns the number of valid (non-NA) entries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>get_length <span class="ot">&lt;-</span> <span class="cf">function</span>(country, set, variable) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">length</span>(<span class="fu">na.omit</span>(country_splits[[country]][[set]][[variable]])))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we begin with the core functions defined for the rolling forecast methodology. We begin by defining a model constructor called <code>fitting_function()</code>; it takes ARIMA orders <span class="math inline">\((p,d,q)\)</span> as input and returns a function that fits a model with those parameters to any given time series.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fitting_function <span class="ot">&lt;-</span> <span class="cf">function</span>(order, <span class="at">use_xreg =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.numeric</span>(order) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(order) <span class="sc">==</span> <span class="dv">3</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (use_xreg) {</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(y, xreg) {</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Arima</span>(y, <span class="at">order =</span> order, <span class="at">xreg =</span> <span class="fu">as.matrix</span>(xreg))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(y) <span class="fu">Arima</span>(y, <span class="at">order =</span> order)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The core of the forecasting mechanism is implemented in the function <code>rolling_forecast()</code>.</p>
<p>This function simulates a real-time prediction scenario by iteratively refitting the model to an expanding training set. At each iteration, it fits the model to the currently available data and generates forecasts up to a specified horizon (e.g., 1, 3, and 5 years ahead). These predictions are stored in a matrix with dimensions corresponding to the length of the test set and the number of horizons. Importantly, the function only retains the forecasted values that correspond to actual future observations in the test set, ensuring a fair comparison. The following table shows the main idea of the function:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> Iteration Data_used_to_fit Forecast_block                     Data_stored
         1        1951–2010      2011–2015 h1 → 2011, h3 → 2013, h5 → 2015
         2        1951–2011      2012–2016 h1 → 2012, h3 → 2014, h5 → 2016
         3        1951–2012      2013–2017 h1 → 2013, h3 → 2015, h5 → 2017</code></pre>
</div>
</div>
<p>To visualize the model behavior at different forecast horizons, the function <code>make_horizon_plots()</code> creates a series of time series plots. It takes as input the training and testing series, along with two fitting functions (one for the manually specified model and another using <code>auto.arima()</code>), and returns separate plots for each forecast horizon (1, 3, and 5 years). In each plot, the actual data are shown in the original scale, alongside the predictions from both models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>plot_horizons <span class="ot">&lt;-</span> <span class="cf">function</span>(test_log_series, forecast_list, <span class="at">horizons =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>)) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  horizons_labels <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"h"</span>, horizons)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  year_vector <span class="ot">&lt;-</span> <span class="fu">time</span>(test_log_series)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  test_raw <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">as.numeric</span>(test_log_series))</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  build_long_df <span class="ot">&lt;-</span> <span class="cf">function</span>(forecasting_matrix, model_label) {</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.frame</span>(forecasting_matrix) <span class="sc">%&gt;%</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">year =</span> year_vector) <span class="sc">%&gt;%</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="sc">-</span>year, <span class="at">names_to =</span> <span class="st">"Horizon"</span>, <span class="at">values_to =</span> <span class="st">"Value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Value =</span> <span class="fu">exp</span>(<span class="fu">as.numeric</span>(Value)), <span class="at">Model =</span> model_label)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  df_manual <span class="ot">&lt;-</span> <span class="fu">build_long_df</span>(forecast_list<span class="sc">$</span>manual<span class="sc">$</span>mean, <span class="st">"manualARIMA"</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  df_auto   <span class="ot">&lt;-</span> <span class="fu">build_long_df</span>(forecast_list<span class="sc">$</span>auto<span class="sc">$</span>mean,   <span class="st">"autoARIMA"</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  df_obs    <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">year =</span> year_vector, <span class="at">Horizon =</span> <span class="st">"Observed"</span>, <span class="at">Model =</span> <span class="st">"Observed"</span>, <span class="at">Value =</span> test_raw)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  plot_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(df_obs, df_manual, df_auto) <span class="sc">%&gt;%</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Horizon =</span> <span class="fu">factor</span>(Horizon, <span class="at">levels =</span> <span class="fu">c</span>(horizons_labels, <span class="st">"Observed"</span>)))</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  col_map <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Observed =</span> <span class="st">"#1f77b4"</span>, <span class="at">autoARIMA =</span> <span class="st">"#6ba292"</span>, <span class="at">manualARIMA =</span> <span class="st">"#ff7f0e"</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  lty_map <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Observed =</span> <span class="st">"solid"</span>,   <span class="at">autoARIMA =</span> <span class="st">"dashed"</span>, <span class="at">manualARIMA =</span> <span class="st">"dashed"</span>)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  make_single_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(h_label) {</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">filter</span>(plot_df, Horizon <span class="sc">==</span> h_label <span class="sc">|</span> Model <span class="sc">==</span> <span class="st">"Observed"</span>),</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>           <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> Value, <span class="at">colour =</span> Model, <span class="at">linetype =</span> Model)) <span class="sc">+</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_line</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">Observed =</span> <span class="st">"#1f77b4"</span>, <span class="at">autoARIMA =</span> <span class="st">"#6ba292"</span>, <span class="at">manualARIMA =</span> <span class="st">"#ff7f0e"</span>)) <span class="sc">+</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">Observed =</span> <span class="st">"solid"</span>,   <span class="at">autoARIMA =</span> <span class="st">"dashed"</span>, <span class="at">manualARIMA =</span> <span class="st">"dashed"</span>)) <span class="sc">+</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">""</span>,</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">y =</span> <span class="st">"Number of deaths"</span>,</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>           <span class="at">colour =</span> <span class="st">"Series"</span>, <span class="at">linetype =</span> <span class="st">"Series"</span>) <span class="sc">+</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>)</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>  plots <span class="ot">&lt;-</span> <span class="fu">lapply</span>(horizons_labels, make_single_plot)</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(plots) <span class="ot">&lt;-</span> horizons_labels</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  plots</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a><span class="co">#paste("Forecast horizon:", h_label)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In addition to visual inspection, we provide quantitative tools to assess forecast accuracy. The function <code>compute_accuracy_table()</code> computes key performance metrics such as Mean Error (ME), Root Mean Squared Error (RMSE), Mean Absolute Error (MAE), Mean Percentage Error (MPE) and Mean Absolute Percentage Error (MAPE).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>compute_accuracy_table <span class="ot">&lt;-</span> <span class="cf">function</span>(test_log, forecast_list, <span class="at">horizons =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>)) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  horizons_labels <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"h"</span>, horizons)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  rows <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  test_orig <span class="ot">&lt;-</span> <span class="fu">exp</span>(test_log)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (model_name <span class="cf">in</span> <span class="fu">names</span>(forecast_list)) {</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    predicted_log <span class="ot">&lt;-</span> forecast_list[[model_name]]<span class="sc">$</span>mean</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    predicted_orig <span class="ot">&lt;-</span> <span class="fu">exp</span>(predicted_log)  </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (h_lab <span class="cf">in</span> horizons_labels) {</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>      keep <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(predicted_orig[, h_lab])</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>      rows[[<span class="fu">paste</span>(model_name, h_lab, <span class="at">sep =</span> <span class="st">"_"</span>)]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">Model =</span> <span class="fu">paste0</span>(<span class="fu">ifelse</span>(model_name <span class="sc">==</span> <span class="st">"auto"</span>, <span class="st">"autoARIMA"</span>, <span class="st">"manualARIMA"</span>), <span class="st">"-"</span>, h_lab),</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">ME    =</span> <span class="fu">mean</span>(test_orig[keep] <span class="sc">-</span> predicted_orig[keep, h_lab]),</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSE  =</span> <span class="fu">rmse</span>(test_orig[keep], predicted_orig[keep, h_lab]),</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE   =</span> <span class="fu">mae</span> (test_orig[keep], predicted_orig[keep, h_lab]),</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAPE  =</span> <span class="fu">mape</span>(test_orig[keep], predicted_orig[keep, h_lab]) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">row.names =</span> <span class="cn">NULL</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(rows)</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, function <code>run_country_forecast()</code> helps getting the computed information of a specific country.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>run_country_forecast <span class="ot">&lt;-</span> <span class="cf">function</span>(country, start_year, order_manual,</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                                 order_auto, <span class="at">horizons =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>), <span class="at">use_xreg =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (use_xreg) {</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    train_raw <span class="ot">&lt;-</span> countries_short[[country]]<span class="sc">$</span>train<span class="sc">$</span>number_deaths</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    test_raw  <span class="ot">&lt;-</span> countries_short[[country]]<span class="sc">$</span>test<span class="sc">$</span>number_deaths</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    train_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">log</span>(train_raw), <span class="at">start =</span> start_year, <span class="at">frequency =</span> <span class="dv">1</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    test_ts  <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">log</span>(test_raw),  <span class="at">start =</span> <span class="fu">end</span>(train_ts)[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span>, <span class="at">frequency =</span> <span class="dv">1</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    xreg_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">population =</span> <span class="fu">ts</span>(<span class="fu">log</span>(countries_short[[country]]<span class="sc">$</span>train<span class="sc">$</span>population), <span class="at">start =</span> start_year, <span class="at">frequency =</span> <span class="dv">1</span>),</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">gdp_capita =</span> <span class="fu">ts</span>(<span class="fu">log</span>(countries_short[[country]]<span class="sc">$</span>train<span class="sc">$</span>gdp_capita), <span class="at">start =</span> start_year, <span class="at">frequency =</span> <span class="dv">1</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    xreg_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">population =</span> <span class="fu">ts</span>(<span class="fu">log</span>(countries_short[[country]]<span class="sc">$</span>test<span class="sc">$</span>population), <span class="at">start =</span> <span class="fu">end</span>(train_ts)[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span>, <span class="at">frequency =</span> <span class="dv">1</span>),</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">gdp_capita =</span> <span class="fu">ts</span>(<span class="fu">log</span>(countries_short[[country]]<span class="sc">$</span>test<span class="sc">$</span>gdp_capita), <span class="at">start =</span> <span class="fu">end</span>(train_ts)[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span>, <span class="at">frequency =</span> <span class="dv">1</span>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    fc_list <span class="ot">&lt;-</span> <span class="fu">rolling_forecast_generic</span>(train_ts, test_ts, order_manual, order_auto,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">use_xreg =</span> <span class="cn">TRUE</span>, <span class="at">xreg_train =</span> xreg_train, <span class="at">xreg_test =</span> xreg_test,</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">horizons =</span> horizons)</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    train_raw <span class="ot">&lt;-</span> country_splits[[country]]<span class="sc">$</span>train<span class="sc">$</span>number_deaths</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    test_raw  <span class="ot">&lt;-</span> country_splits[[country]]<span class="sc">$</span>test<span class="sc">$</span>number_deaths</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    train_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">log</span>(train_raw), <span class="at">start =</span> start_year, <span class="at">frequency =</span> <span class="dv">1</span>)</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    test_ts  <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">log</span>(test_raw),  <span class="at">start =</span> <span class="fu">end</span>(train_ts)[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span>, <span class="at">frequency =</span> <span class="dv">1</span>)</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>    fc_list <span class="ot">&lt;-</span> <span class="fu">rolling_forecast_generic</span>(train_ts, test_ts, order_manual, order_auto,</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">use_xreg =</span> <span class="cn">FALSE</span>, <span class="at">horizons =</span> horizons)</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  accuracy_tbl <span class="ot">&lt;-</span> <span class="fu">compute_accuracy_table</span>(test_ts, fc_list, <span class="at">horizons =</span> horizons)</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>  plots <span class="ot">&lt;-</span> <span class="fu">plot_horizons</span>(test_ts, fc_list, <span class="at">horizons =</span> horizons)</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">metrics =</span> accuracy_tbl, <span class="at">plots =</span> plots, <span class="at">forecasts =</span> fc_list)</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This function is required in order to get the boundaries of the confidence intervals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>calc_exp_bounds <span class="ot">&lt;-</span> <span class="cf">function</span>(res, model, horizon) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  model   <span class="ot">&lt;-</span> <span class="fu">as.character</span>(model)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  horizon <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(horizon)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  lower_vals <span class="ot">&lt;-</span> res<span class="sc">$</span>forecasts[[model]][[<span class="st">"lower"</span>]][ , horizon]</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  lower_vals <span class="ot">&lt;-</span> <span class="fu">exp</span>(lower_vals[<span class="sc">!</span><span class="fu">is.na</span>(lower_vals)])</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  upper_vals <span class="ot">&lt;-</span> res<span class="sc">$</span>forecasts[[model]][[<span class="st">"upper"</span>]][ , horizon]</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  upper_vals <span class="ot">&lt;-</span> <span class="fu">exp</span>(upper_vals[<span class="sc">!</span><span class="fu">is.na</span>(upper_vals)])</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">min =</span> <span class="fu">min</span>(lower_vals), <span class="at">max =</span> <span class="fu">max</span>(upper_vals))</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="arima-models" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="arima-models"><span class="header-section-number">6</span> ARIMA models</h2>
<p>In this section, we analyze the temporal dynamics of tuberculosis-related mortality across the selected European countries using ARIMA models. Each country will be studied individually, beginning with an exploratory analysis of the log-transformed mortality data. Model parameters (p,d,q) will be selected based on empirical diagnostics such as the ACF/PACF plots and the AIC. The adequacy of each model will be verified through residual analysis.</p>
<section id="spain" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="spain"><span class="header-section-number">6.1</span> Spain</h3>
<p>We begin our analysis with the Spanish dataset, which spans from 1951 to 2021 and comprises 71 annual observations. Given the long time span and the observed declining trend in raw counts, a logarithmic transformation is applied to stabilize variance and linearize the trend. The figure below shows the log-transformed training time series for tuberculosis mortality in Spain.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-28-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In order to formally assess whether the series is stationary, we apply the Augmented Dickey-Fuller (ADF) test:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  train_spain
Dickey-Fuller = 0.097996, Lag order = 3, p-value = 0.99
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>As expected, the high <span class="math inline">\(p\)</span>-value indicates that we fail to reject the null hypothesis, which suggests that the series is non-stationary. In this case, applying a first-order difference is recommended.</p>
<p>We can apply the ADF test to the differenced time series:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  train_spain %&gt;% diff()
Dickey-Fuller = -4.729, Lag order = 3, p-value = 0.01
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>The test <span class="math inline">\(p\)</span>-value ensures the stationarity of the time series. Now, we check the ACF and PACF of the differenced time series:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-31-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Neither the ACF nor the PACF show any ignificant spikes—autocorrelations at higher lags lie well within the confidence bounds. This suggest that the series present no AR or MA structure left after the differences. We first fit the auto.arima model:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_spain 
ARIMA(0,1,0) with drift 

Coefficients:
        drift
      -0.0712
s.e.   0.0125

sigma^2 = 0.009433:  log likelihood = 54.37
AIC=-104.73   AICc=-104.52   BIC=-100.58

Training set error measures:
                       ME       RMSE        MAE        MPE      MAPE      MASE
Training set 0.0001707495 0.09549223 0.06505728 0.05485524 0.8823353 0.7573006
                    ACF1
Training set -0.03232898</code></pre>
</div>
</div>
<p>The auto.arima() procedure suggests an ARIMA(0,1,0) specification, indicating that the series follows a random walk without drift. The corresponding AIC is relatively low (<span class="math inline">\(-104.73\)</span>), supporting the adequacy of this simple model. Moreover, the in-sample performance is satisfactory, with a root mean squared error (RMSE) of <span class="math inline">\(0.096\)</span> and a mean absolute percentage error (MAPE) below 1% on the log-transformed training set.</p>
<p>Nonetheless, in pursuit of a potentially more flexible and interpretable model, we consider a broader set of ARIMA specifications that include either an AR(1) or MA(1) component. This aims to assess whether a slightly more complex model can better capture the underlying dynamics, or whether the series can indeed be sufficiently described as a random walk process.</p>
<p>We apply the try_all_arima using <span class="math inline">\(p,q \in \{0,1\}\)</span>:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>ARIMA(0,1,0)
numeric(0)
AIC: -80.98195 

ARIMA(0,1,1)
      ma1 
0.2221241 
AIC: -83.04884 

ARIMA(1,1,0)
      ar1 
0.4144206 
AIC: -86.8848 

ARIMA(1,1,1)
       ar1        ma1 
 0.9948514 -0.9065015 
AIC: -100.2475 </code></pre>
</div>
</div>
<p>The model with the lowest AIC (specifically, with a value of <span class="math inline">\(-100.25\)</span>) is the ARIMA(<span class="math inline">\(1,1,1\)</span>). We proceed with the residuals diagnostics of both models.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_spain 
ARIMA(1,1,1) 

Coefficients:
         ar1      ma1
      0.9949  -0.9065
s.e.  0.0097   0.0825

sigma^2 = 0.009734:  log likelihood = 53.12
AIC=-100.25   AICc=-99.81   BIC=-94.01

Training set error measures:
                     ME       RMSE        MAE       MPE      MAPE      MASE
Training set 0.01508809 0.09616155 0.07162376 0.1940579 0.9526722 0.8337379
                   ACF1
Training set -0.1306316</code></pre>
</div>
</div>
<p>First, the auto.arima:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,1,0) with drift
Q* = 3.1727, df = 10, p-value = 0.9771

Model df: 0.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_spain_auto)
W = 0.88078, p-value = 2.812e-05</code></pre>
</div>
</div>
<p>Just by checking the residuals distribution function on the <code>checkresiduals</code> plot, it is clear that the residuals of the autogenerated model do not pass the Shapiro-Wilk normality test.</p>
<p>Then, the residuals of the manual model:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(1,1,1)
Q* = 5.2251, df = 8, p-value = 0.7333

Model df: 2.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_spain_111)
W = 0.93669, p-value = 0.00386</code></pre>
</div>
</div>
<p>The residuals of the manual model do not pass neither the normality assumption. However, we proceed with the forecasting step.</p>
<p>First, we validate the accuracy of both models:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model         ME     RMSE      MAE      MAPE
1 manualARIMA-h1  -6.385521 33.77663 23.83166  9.064466
2 manualARIMA-h3  -5.780201 33.42234 26.29010 10.982598
3 manualARIMA-h5  -3.861883 36.88061 27.01811 11.646959
4   autoARIMA-h1 -19.818182 38.32872 28.00000 11.034066
5   autoARIMA-h3 -45.666667 55.56078 46.77778 20.367954
6   autoARIMA-h5 -70.000000 78.31438 70.00000 31.490932</code></pre>
</div>
</div>
<p>The manual ARIMA model consistently outperforms the automatic specification across all horizons. In particular, it achieves substantially lower RMSE and MAE values, especially for medium- and long-term forecasts. For example, at horizon <span class="math inline">\(h=5\)</span>, the manual model yields an RMSE of 36.88 and a MAPE of 11.65%, whereas the automatic model reaches 78.31 and 31.49%, respectively. Moreover, the manual model maintains smaller forecast biases (ME) across horizons, suggesting a more balanced and accurate predictive behavior.</p>
<p>Now, we can plot the forecasting results:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-38-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-38-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notably, both models tend to slightly overestimate the first forecasted value. Across all three horizons, the manual ARIMA provides more accurate approximations than the automatically selected model. This is particularly evident in the five-step-ahead forecasts, where the autoARIMA overpredicts by up to 50 tuberculosis-related deaths.</p>
</section>
<section id="the-netherlands" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="the-netherlands"><span class="header-section-number">6.2</span> The Netherlands</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-41-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In order to select the model, first, we study the order of differences needed to ensure stationarity.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  train_netherlands %&gt;% diff()
Dickey-Fuller = -3.9401, Lag order = 3, p-value = 0.01832
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>The series need a first order difference to get stationary. We check the ACF and PACF plots:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-43-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>After apply a first order difference, the series ACF plot (first) shows a significant spike at lag 3, and the PACF plot shows significant spikes at lags 3 and 7.</p>
<p>Let’s see which model suggests the auto.arima function:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_netherlands 
ARIMA(0,0,5) with non-zero mean 

Coefficients:
         ma1     ma2     ma3     ma4     ma5    mean
      1.5353  1.5598  1.5961  1.0715  0.3912  5.2624
s.e.  0.1205  0.1772  0.1866  0.1755  0.1135  0.1849

sigma^2 = 0.04844:  log likelihood = 6.62
AIC=0.76   AICc=2.87   BIC=15.53

Training set error measures:
                      ME      RMSE       MAE        MPE     MAPE     MASE
Training set -0.01663869 0.2089804 0.1552186 -0.6530894 3.023355 1.143404
                    ACF1
Training set -0.06522102</code></pre>
</div>
</div>
<p>The auto generated model is the ARIMA(0,0,5), meaning no differences are required. For the manual model, we apply the try_all_arima function</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>ARIMA(0,1,0)
numeric(0)
AIC: -40.43847 

ARIMA(0,1,1)
       ma1 
0.07519299 
AIC: -38.67249 

ARIMA(0,1,3)
       ma1        ma2        ma3 
 0.1202990 -0.1654972  0.3268827 
AIC: -44.57876 

ARIMA(1,1,0)
       ar1 
0.05426584 
AIC: -38.61415 

ARIMA(1,1,1)
       ar1        ma1 
 0.9881737 -0.9236795 
AIC: -41.83802 

ARIMA(1,1,3)
       ar1        ma1        ma2        ma3 
 0.9630927 -1.1487760 -0.3512917  0.7221007 
AIC: -54.2527 

ARIMA(3,1,0)
       ar1        ar2        ar3 
 0.1151307 -0.1120137  0.4354949 
AIC: -46.70276 

ARIMA(3,1,1)
       ar1        ar2        ar3        ma1 
 0.6851742 -0.1525448  0.4400546 -0.7677572 
AIC: -49.14288 

ARIMA(3,1,3)
       ar1        ar2        ar3        ma1        ma2        ma3 
 0.8273118  0.3646465 -0.2405588 -0.9934322 -0.6516897  0.8810866 
AIC: -51.6565 </code></pre>
</div>
</div>
<p>The best model, which minimizes the AIC (<span class="math inline">\(-54.25\)</span>) is the ARIMA(1,1,3). We now check the assumptions on the residuals of the both models.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,0,5) with non-zero mean
Q* = 14.839, df = 5, p-value = 0.01107

Model df: 5.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_netherlands_auto)
W = 0.96665, p-value = 0.09472</code></pre>
</div>
</div>
<p>The residuals for the autogenerate model do not satisfy the hypothesis.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_netherlands 
ARIMA(1,1,3) 

Coefficients:
         ar1      ma1      ma2     ma3
      0.9631  -1.1488  -0.3513  0.7221
s.e.  0.0342   0.1632   0.1880  0.1398

sigma^2 = 0.0191:  log likelihood = 32.13
AIC=-54.25   AICc=-53.14   BIC=-43.78

Training set error measures:
                       ME      RMSE      MAE       MPE    MAPE      MASE
Training set -0.002281969 0.1324053 0.103887 -0.043115 2.07381 0.7652745
                     ACF1
Training set 0.0005772235</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(1,1,3)
Q* = 6.2261, df = 6, p-value = 0.3983

Model df: 4.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_netherlands_113)
W = 0.95991, p-value = 0.0437</code></pre>
</div>
</div>
<p>On the contrary, the residuals of the manual model satisfy the no autocorrelation assumption, however, the normality is not ensured (<span class="math inline">\(p\)</span>-value of <span class="math inline">\(0.04\)</span>). We begin the forecast step:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model           ME       RMSE        MAE      MAPE
1 manualARIMA-h1   -1.2063727   6.814306   5.295748  19.10182
2 manualARIMA-h3   -0.7584739   5.101757   3.923201  13.76059
3 manualARIMA-h5   -1.9934569   5.042829   3.888810  13.82896
4   autoARIMA-h1  -11.0473735  18.450216  13.336870  52.34180
5   autoARIMA-h3  -54.5810613  63.254653  54.581061 214.52740
6   autoARIMA-h5 -129.6668084 130.601824 129.666808 536.18507</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-50-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-50-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The auto.arima model is clearly inadequate for this series: the large ME values reveal a systematic tendency to over-forecast, and the three- and five-step MAPE values exceed 200 %, signalling a very poor fit. By contrast, the manually specified model yields much smaller error metrics and appears to capture the underlying trend of the series.</p>
</section>
<section id="switzerland" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="switzerland"><span class="header-section-number">6.3</span> Switzerland</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-52-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We check the stationary of the series:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  train_switzerland
Dickey-Fuller = -3.9644, Lag order = 3, p-value = 0.01725
alternative hypothesis: stationary</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    KPSS Test for Level Stationarity

data:  train_switzerland
KPSS Level = 1.5938, Truncation lag parameter = 3, p-value = 0.01</code></pre>
</div>
</div>
<p>Notably, the series passes the ADF test without differencing, suggesting stationarity. However, the visual inspection reveals a clear downward trend, which contradicts this result and raises concerns about potential non-stationarity. To clarify this discrepancy, we applied the KPSS test, which assumes stationarity as the null hypothesis. The KPSS result (<span class="math inline">\(p\)</span>-value of <span class="math inline">\(0.01\)</span>) leads us to reject stationarity, thereby supporting the use of first-order differencing before model fitting.</p>
<p>Next, we check the ACF and PACF of the first order differenced time series.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-55-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The series, after a first difference, does not present any temporal structure left. We check the auto.arima function:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_switzerland 
ARIMA(0,1,1) with drift 

Coefficients:
          ma1    drift
      -0.2622  -0.0695
s.e.   0.1671   0.0141

sigma^2 = 0.02193:  log likelihood = 29.96
AIC=-53.91   AICc=-53.48   BIC=-47.68

Training set error measures:
                       ME      RMSE       MAE         MPE     MAPE      MASE
Training set -0.001179008 0.1443274 0.1039542 -0.01669039 2.261343 0.8563823
                   ACF1
Training set 0.04579578</code></pre>
</div>
</div>
<p>The selected model of the auto.arima function is ARIMA(0,1,1). Then, for the manual model, as the series seems to behave as a <span class="math inline">\(0,1,0\)</span> (random walk), we apply the try_all_arima in order to study if another model should present better performance.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>ARIMA(0,0,0)
intercept 
 5.172568 
AIC: 198.7086 

ARIMA(0,0,1)
      ma1 intercept 
0.9999997 5.1873581 
AIC: 127.7822 

ARIMA(0,1,0)
numeric(0)
AIC: -43.39935 

ARIMA(0,1,1)
       ma1 
0.02411476 
AIC: -41.43854 

ARIMA(1,0,0)
      ar1 intercept 
0.9964397 5.3512506 
AIC: -35.26378 

ARIMA(1,0,1)
       ar1        ma1  intercept 
0.99625444 0.02558055 5.35418556 
AIC: -33.30749 

ARIMA(1,1,0)
       ar1 
0.02916534 
AIC: -41.44685 

ARIMA(1,1,1)
       ar1        ma1 
 0.9998211 -0.9916482 
AIC: -47.67385 </code></pre>
</div>
</div>
<p>We will study the ARIMA(<span class="math inline">\(1,1,1\)</span>).</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_switzerland 
ARIMA(1,1,1) 

Coefficients:
         ar1      ma1
      0.9998  -0.9916
s.e.  0.0009   0.0203

sigma^2 = 0.02355:  log likelihood = 26.84
AIC=-47.67   AICc=-47.24   BIC=-41.44

Training set error measures:
                       ME     RMSE       MAE        MPE     MAPE      MASE
Training set -0.006518849 0.149589 0.1046295 -0.1116054 2.302596 0.8619455
                   ACF1
Training set -0.1749837</code></pre>
</div>
</div>
<p>Now it is time to check the residuals diagnostics of both models, beginning with the automatic one:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,1,1) with drift
Q* = 8.4678, df = 9, p-value = 0.4878

Model df: 1.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_switzerland_auto)
W = 0.92632, p-value = 0.001392</code></pre>
</div>
</div>
<p>The residuals for the autogenerate model do not satisfy the normality hypothesis.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(1,1,1)
Q* = 9.3313, df = 8, p-value = 0.3151

Model df: 2.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_switzerland_111)
W = 0.91379, p-value = 0.0004353</code></pre>
</div>
</div>
<p>Neither the residuals of the manually selected model seem to distribute normally. We begin the forecast step</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model        ME     RMSE      MAE     MAPE
1 manualARIMA-h1 -0.220961 6.765646 5.386294 40.01251
2 manualARIMA-h3 -1.204678 7.684957 6.925315 49.61632
3 manualARIMA-h5  1.695709 5.049992 3.680891 18.65320
4   autoARIMA-h1 -1.134879 6.986668 5.888696 43.15585
5   autoARIMA-h3 -4.050172 8.841633 7.924870 60.77865
6   autoARIMA-h5 -4.007599 6.512138 5.478493 37.16015</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-62-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-62-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Although any of both models ensures the normality of residuals, both models present quite well-fitted model features; however, the manual model seems to outperform in all three forecast horizons.</p>
</section>
<section id="sweden" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="sweden"><span class="header-section-number">6.4</span> Sweden</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-64-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We check first the order of differences required to ensure stationarity:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  train_sweden %&gt;% diff()
Dickey-Fuller = -3.6087, Lag order = 3, p-value = 0.04007
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>We need to difference the series once to ensure stationarity. Now, we check the ACF and PACF of the differenced time series:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-66-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ACF and PACF show significant spikes at lag 8, both. However, a simpler model should also be studied. First, let’s check which is the auto.arima model selected:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_sweden 
ARIMA(0,1,1) with drift 

Coefficients:
          ma1    drift
      -0.3354  -0.0592
s.e.   0.1217   0.0138

sigma^2 = 0.02624:  log likelihood = 25.04
AIC=-44.08   AICc=-43.65   BIC=-37.8

Training set error measures:
                       ME      RMSE       MAE         MPE     MAPE      MASE
Training set -0.001665523 0.1579452 0.1234212 -0.05052666 2.540635 0.9369797
                   ACF1
Training set 0.01103397</code></pre>
</div>
</div>
<p>The auto generated model is the ARIMA(0,1,1), with an AIC of <span class="math inline">\(-44.08\)</span>. Now, we study the manual model:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>ARIMA(0,1,0)
numeric(0)
AIC: -34.99772 

ARIMA(0,1,1)
       ma1 
-0.1167642 
AIC: -33.86476 

ARIMA(1,1,0)
       ar1 
-0.1280543 
AIC: -33.92638 

ARIMA(1,1,1)
       ar1        ma1 
 0.9996342 -0.9912066 
AIC: -35.1225 </code></pre>
</div>
</div>
<p>The model that minimizes the AIC is ARIMA(1,1,1), meaning the series depends on eight past values and adds a moving average component.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_sweden 
ARIMA(1,1,1) 

Coefficients:
         ar1      ma1
      0.9996  -0.9912
s.e.  0.0021   0.0242

sigma^2 = 0.02975:  log likelihood = 20.56
AIC=-35.12   AICc=-34.69   BIC=-28.84

Training set error measures:
                       ME      RMSE       MAE        MPE     MAPE      MASE
Training set -0.007107134 0.1681944 0.1223335 -0.1567237 2.541821 0.9287218
                   ACF1
Training set -0.2543212</code></pre>
</div>
</div>
<p>We need to further check the residuals of both models.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-70-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,1,1) with drift
Q* = 10.946, df = 9, p-value = 0.2795

Model df: 1.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_sweden_auto)
W = 0.96871, p-value = 0.1201</code></pre>
</div>
</div>
<p>The residuals for the autogenerate model satisfy both assumptions. Now, we check the manual model:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(1,1,1)
Q* = 19.439, df = 8, p-value = 0.01268

Model df: 2.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_sweden_111)
W = 0.95384, p-value = 0.02204</code></pre>
</div>
</div>
<p>As the residuals do not ensure the no autocorrelation assumption, a new model should be applied. We study a higher order parameters:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>ARIMA(0,1,0)
numeric(0)
AIC: -34.99772 

ARIMA(0,1,1)
       ma1 
-0.1167642 
AIC: -33.86476 

ARIMA(0,1,8)
        ma1         ma2         ma3         ma4         ma5         ma6 
-0.15039039 -0.02291404 -0.01171015  0.35613763  0.01552930  0.15563899 
        ma7         ma8 
 0.32711502 -0.08202873 
AIC: -34.21034 

ARIMA(1,1,0)
       ar1 
-0.1280543 
AIC: -33.92638 

ARIMA(1,1,1)
       ar1        ma1 
 0.9996342 -0.9912066 
AIC: -35.1225 

ARIMA(1,1,8)
        ar1         ma1         ma2         ma3         ma4         ma5 
-0.23459315  0.07731513 -0.04910164 -0.01162903  0.34577677  0.10336287 
        ma6         ma7         ma8 
 0.16169634  0.36668597 -0.02360324 
AIC: -32.30327 

ARIMA(8,1,0)
        ar1         ar2         ar3         ar4         ar5         ar6 
-0.11576040 -0.01889063  0.07692924  0.42895267  0.09623029  0.21697099 
        ar7         ar8 
 0.25959551 -0.31715937 
AIC: -39.60436 

ARIMA(8,1,1)
        ar1         ar2         ar3         ar4         ar5         ar6 
-0.07708817 -0.01209823  0.07890077  0.42743226  0.08457287  0.21479733 
        ar7         ar8         ma1 
 0.25115292 -0.33068287 -0.04148451 
AIC: -37.61643 

ARIMA(8,1,8)
        ar1         ar2         ar3         ar4         ar5         ar6 
-1.26612795 -0.25236459  0.39379395  0.30604272  0.02282242  0.22693057 
        ar7         ar8         ma1         ma2         ma3         ma4 
 0.97045010  0.59825177  1.20989843  0.11131010 -0.58834690  0.12010574 
        ma5         ma6         ma7         ma8 
 0.54804831 -0.30839644 -1.34100989 -0.71334681 
AIC: -36.30656 </code></pre>
</div>
</div>
<p>It seems that an ARIMA(<span class="math inline">\(8,1,0\)</span>) could fit well. We check the residuals diagnostics:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-73-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(8,1,0)
Q* = 2.5261, df = 3, p-value = 0.4706

Model df: 8.   Total lags used: 11</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_sweden_810)
W = 0.96702, p-value = 0.09882</code></pre>
</div>
</div>
<p>Residuals now present no autocorrelation left; however, they do not distribute normally. We begin the forecast step.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model          ME      RMSE       MAE     MAPE
1 manualARIMA-h1  -0.7773976  6.132089  4.937730 20.21371
2 manualARIMA-h3  -1.6494905  4.787073  4.207559 20.46571
3 manualARIMA-h5  -3.0858039  6.479928  5.393518 26.43631
4   autoARIMA-h1  -2.4585319  5.663790  4.524810 19.42574
5   autoARIMA-h3  -8.2104252 10.175130  8.367616 38.77765
6   autoARIMA-h5 -12.4955541 14.013185 12.495554 63.43650</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-75-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-75-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-75-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The auto.arima model seems to outperform the manual one in the one-step-ahead forecasts, in both accuracy metrics and visual forecasts. However, as the horizon increases, the manual one seems to outperform the auto.arima selected model.</p>
</section>
<section id="bulgaria" class="level3" data-number="6.5">
<h3 data-number="6.5" class="anchored" data-anchor-id="bulgaria"><span class="header-section-number">6.5</span> Bulgaria</h3>
<p>Now, we study Bulgaria data. As seen in the introduction, Bulgaria has a different trend for number_deaths series.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-77-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-77-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We first use the ADF test to assess whether the series is stationary or not.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  train_bulgaria
Dickey-Fuller = -2.1424, Lag order = 3, p-value = 0.5173
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>Without any difference, the series is not stationary. After two differences, we get stationarity.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  train_bulgaria %&gt;% diff(differences = 2)
Dickey-Fuller = -5.4371, Lag order = 3, p-value = 0.01
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>Let’s see which ARIMA order proposes the auto.arima() function.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_bulgaria 
ARIMA(0,1,0) with drift 

Coefficients:
        drift
      -0.0409
s.e.   0.0147

sigma^2 = 0.01038:  log likelihood = 41.16
AIC=-78.32   AICc=-78.05   BIC=-74.62

Training set error measures:
                       ME       RMSE        MAE         MPE    MAPE      MASE
Training set 0.0001478023 0.09973848 0.07737386 0.001195524 1.32575 0.8967336
                   ACF1
Training set 0.07537416</code></pre>
</div>
</div>
<p>The model proposed is an ARIMA(0,1,0) with drift, that has an AIC of <span class="math inline">\(-78.32\)</span>. In order to determine an alternative model, we check the ACF and PACF plots of the time series.</p>
<p>First, we check the ACF and PACF of the first-order differences:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-81-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-81-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>After one difference, the series does not present any structure left, justifying the selection criteria of the auto.arima function. Now, we check the two-order differences ACF and PACF:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-82-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ACF now shows a single first significant lag, whether the PACF shows an increasing pattern over the first few lags. Now, we apply the try_all_arima to find the best model:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>ARIMA(0,2,0)
numeric(0)
AIC: -50.0364 

ARIMA(0,2,1)
       ma1 
-0.8574481 
AIC: -72.35493 

ARIMA(1,2,0)
       ar1 
-0.4419734 
AIC: -57.95435 

ARIMA(1,2,1)
         ar1          ma1 
 0.001412857 -0.858281340 
AIC: -70.35498 

ARIMA(2,2,0)
       ar1        ar2 
-0.6305582 -0.4363226 
AIC: -65.47341 

ARIMA(2,2,1)
       ar1        ar2        ma1 
-0.1495715 -0.2169690 -0.6899612 
AIC: -69.43206 </code></pre>
</div>
</div>
<p>The model with the lowest AIC (of <span class="math inline">\(-72.35\)</span>) is ARIMA(<span class="math inline">\(0,2,1\)</span>). Now, we check the residuals diagnostic of both models:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_bulgaria 
ARIMA(0,2,1) 

Coefficients:
          ma1
      -0.8574
s.e.   0.1229

sigma^2 = 0.01106:  log likelihood = 38.18
AIC=-72.35   AICc=-72.08   BIC=-68.7

Training set error measures:
                       ME      RMSE        MAE         MPE     MAPE     MASE
Training set -0.002789192 0.1018244 0.07529418 -0.04991614 1.293325 0.872631
                    ACF1
Training set -0.01556096</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-85-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,2,1)
Q* = 5.2802, df = 9, p-value = 0.8092

Model df: 1.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_bulgaria_021)
W = 0.97709, p-value = 0.4641</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-86-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,1,0) with drift
Q* = 5.4184, df = 10, p-value = 0.8615

Model df: 0.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_bulgaria_auto)
W = 0.98861, p-value = 0.9188</code></pre>
</div>
</div>
<p>The residuals of both models satisfy the assumptions on residuals. We begin the forecast step by checking the accuracy metrics of both models.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model         ME     RMSE      MAE     MAPE
1 manualARIMA-h1  -3.540881 12.21924 11.32359 12.13806
2 manualARIMA-h3  -8.683038 16.19364 13.12803 14.63030
3 manualARIMA-h5 -12.867525 21.86997 18.32705 22.26276
4   autoARIMA-h1 -11.500000 15.95306 12.70000 14.15631
5   autoARIMA-h3 -32.500000 35.13901 32.50000 35.63893
6   autoARIMA-h5 -51.833333 54.07248 51.83333 62.75880</code></pre>
</div>
</div>
<p>In all forecast horizons considered, the manually specified ARIMA models outperformed their automated counterparts, showing lower overall errors and less systematic over-forecasting. The negative mean error values across models indicate a consistent tendency to overestimate tuberculosis deaths, but this bias was less pronounced in the manual models (e.g., –9.2 vs –11.5 at h = 1; –48.4 vs –51.8 at h = 5). RMSE and MAE were also smaller for manual models at every horizon (e.g., RMSE 15.0 → 51.4 vs 16.0 → 54.1; MAE 12.5 → 48.4 vs 12.7 → 51.8). Likewise, MAPE increased with forecast horizon but remained consistently lower for the manual model, staying below 35% through h = 3 and rising more gradually by h = 5 (59.2% vs 62.8%).</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-88-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-88-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-88-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="estonia" class="level3" data-number="6.6">
<h3 data-number="6.6" class="anchored" data-anchor-id="estonia"><span class="header-section-number">6.6</span> Estonia</h3>
<p>Finally, Estonia is studied.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-91-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-91-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s see which model is suggested by the auto.arima function:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_estonia 
ARIMA(0,1,0) 

sigma^2 = 0.06583:  log likelihood = -1.76
AIC=5.52   AICc=5.66   BIC=6.92

Training set error measures:
                     ME      RMSE       MAE        MPE     MAPE      MASE
Training set 0.00204631 0.2523997 0.1741485 -0.1289093 4.029889 0.9685663
                    ACF1
Training set -0.05117422</code></pre>
</div>
</div>
<p>The model proposed is ARIMA(0,1,0), with an AIC of 5.52, meaning the series behaves as a white noise without drift. To further improve this model, to make a more flexible and interpretable model, we check the main characteristics of the series.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  train_estonia
Dickey-Fuller = -2.1342, Lag order = 3, p-value = 0.5211
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>The series is not stationary as observed in the initial plot and proved by the ADF test. Now, we check if after a differenced applied, we get stationarity.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  train_estonia %&gt;% diff()
Dickey-Fuller = -1.8064, Lag order = 3, p-value = 0.647
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>The first order difference is not sufficient to get the series stationary; in fact, second order differences is still not sufficient. We will not study the third-order differenced.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  train_estonia %&gt;% diff(differences = 3)
Dickey-Fuller = -5.0252, Lag order = 3, p-value = 0.01
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>We can check the ACF and PACF plots of both approaches:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-96-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-96-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>After a difference, neither the ACF (left) nor the PACF (right) show any significant lags (this is the justification of the autogenerated selected model).</p>
<p>Now, we check the ACF and PACF of the second order differences:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-97-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-97-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ACF shows a spike at lag 1 that lies outside the confidence boundaries. This behavior is presented too in the PACF plot, but with a negative spike.</p>
<p>We study the best model following the results obtained:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>ARIMA(0,1,0)
numeric(0)
AIC: 5.515208 

ARIMA(0,1,1)
        ma1 
-0.04920013 
AIC: 7.439386 

ARIMA(0,2,0)
numeric(0)
AIC: 27.88502 

ARIMA(0,2,1)
       ma1 
-0.9999999 
AIC: 11.7807 

ARIMA(1,1,0)
       ar1 
-0.0498204 
AIC: 7.438424 

ARIMA(1,1,1)
        ar1         ma1 
-0.10335769  0.05370482 
AIC: 9.438409 

ARIMA(1,2,0)
       ar1 
-0.5953897 
AIC: 18.6065 

ARIMA(1,2,1)
        ar1         ma1 
-0.01798768 -0.99999833 
AIC: 13.77135 </code></pre>
</div>
</div>
<p>The model with the lowest AIC is an ARIMA(1,1,0), meaning that after a first order difference, the series still depends on the past value.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_estonia 
ARIMA(1,1,0) 

Coefficients:
          ar1
      -0.0498
s.e.   0.1797

sigma^2 = 0.06792:  log likelihood = -1.72
AIC=7.44   AICc=7.88   BIC=10.24

Training set error measures:
                      ME      RMSE       MAE        MPE     MAPE      MASE
Training set 0.002043961 0.2520665 0.1753975 -0.1361376 4.051654 0.9755127
                     ACF1
Training set -0.001220662</code></pre>
</div>
</div>
<p>Now, we need to check the residuals assumptions on both models.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-100-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(1,1,0)
Q* = 0.5994, df = 5, p-value = 0.988

Model df: 1.   Total lags used: 6</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_arima_estonia_110)
W = 0.94189, p-value = 0.09311</code></pre>
</div>
</div>
<p>The normality assumption is not guaranteed in the manual fitted model. Neither in the autogenerated one, as seen next:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-101-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,1,0)
Q* = 0.70501, df = 6, p-value = 0.9944

Model df: 0.   Total lags used: 6</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_autoarima_estonia)
W = 0.93813, p-value = 0.07325</code></pre>
</div>
</div>
<p>We can check the accuracy metric on test data of both models:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model         ME      RMSE       MAE     MAPE
1 manualARIMA-h1  -3.308516  6.544428  5.453290 30.56482
2 manualARIMA-h3  -8.234096 10.218633  8.490659 55.21479
3 manualARIMA-h5 -13.376101 13.486564 13.376101 92.95464
4   autoARIMA-h1  -3.090909  6.660603  6.000000 34.05768
5   autoARIMA-h3  -8.000000 10.110501  8.444444 54.20289
6   autoARIMA-h5 -13.142857 13.309503 13.142857 90.89497</code></pre>
</div>
</div>
<p>At all forecast horizons, both the manual and automated ARIMA models showed a systematic tendency to over-forecast tuberculosis deaths, as indicated by negative mean errors. However, the extent of over-forecasting was slightly greater for the manual model at each step (e.g., ME –3.3 vs –3.1 at h = 1; –13.4 vs –13.1 at h = 5). Despite this, overall forecast accuracy was generally comparable between the two approaches. The manual ARIMA exhibited marginally lower root mean square errors (RMSE) at h = 3 and h = 5 (10.2 vs 10.1; 13.5 vs 13.3, respectively), while absolute errors (MAE) were nearly identical. Percentage errors (MAPE), however, revealed a clear difference: the manual model yielded consistently lower MAPE at each horizon (e.g., 30.6% vs 34.1% at h = 1), suggesting better relative accuracy in proportion to the observed values. Nevertheless, MAPE values above 50% from h = 3 onward highlight the inherent challenge of longer-term TB mortality forecasting, regardless of model selection strategy.</p>
<p>The plots of the results are provided next:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-103-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-103-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-103-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="arimax-models" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="arimax-models"><span class="header-section-number">7</span> ARIMAX models</h2>
<p>We have seen that ARIMA models are quite simple in order to do a well-suited forecast for our studied series. In this section we will study ARIMAX models; ARIMAX models are ARIMA models that include some exogenous variables in order to get better forecastings rather than basic ARIMA. In our study, we will consider two exogenous variables: Gross Domestic Product per capita and the country population.</p>
<p>First, we visualize these series.</p>
<p>We begin analysing the Population variable.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-106-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In stark contrast with the other countries, Spain population has a strong increasing trend, climbing from around 28 million in 1950 to nearly 48 million by 2020. The Netherlands also grows steadily, from about 10 million to roughly 18 million. Sweden’s population increases more modestly, moving from approximately 7 million to just over 10 million, while Switzerland rises from about 5 million to nearly 9 million over the same period.</p>
<p>In contrast, Bulgaria peaks near 9 million in the 1980s before gradually declining to about 7 million by 2020, and Estonia remains the smallest, hovering around 1.7 million in 1980 but falling slightly to around 1.3 million by 2020. The plot clearly highlights Spain’s large and sustained growth, moderate increases for Northern and Western European countries, and population declines in Eastern Europe.</p>
<p>Now, let’s visualize the GDP per capita tendencies:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-107-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, the outlook is quite different; Switzerland leads the list, climbing from around $2,000 in 1960 to over $90,000 by 2020, with sharp surges in the late 1990s and post-2005. Following Switzerland, the Netherlands and Sweden follow a similar upward trajectory. Spain increases more modestly, from under $1,000 to a peak of around $35,000 by 2008, then levels out in the $25,000–$30,000 range.Estonia lags until independence—remaining near zero through the Soviet era—then surges after 1992 from around $2,000 to approximately $25,000 by 2020. Bulgaria also starts below $1,000, grows gradually through the 1980s, dips in the 1990s, and then climbs to roughly $12,000 by 2020.</p>
<p>Overall, Switzerland, Sweden, and the Netherlands display long-term, high-income growth; Spain shows moderate growth with a plateau post-2008; and the Eastern European countries (Estonia and Bulgaria) demonstrate rapid catch-up following post-1990 transitions.</p>
<p>Before beginning the ARIMAX section, it is important to give special attention to the length of each of the variables, just to ensure that the studied variable (number_deaths) length coincides with the covariables length.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>      Country number_deaths_length population_length gdp_capita_length
1       Spain                   71                71                62
2 Netherlands                   73                73                63
3      Sweden                   72                72                63
4 Switzerland                   71                71                62
5    Bulgaria                   58                58                42
6     Estonia                   40                40                30</code></pre>
</div>
</div>
<p>It is necessary that all variable have the same length; we create a function in order to automate this step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>slice_country_data <span class="ot">&lt;-</span> <span class="cf">function</span>(country, start_year) {</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  df_full <span class="ot">&lt;-</span> country_splits[[country]][[<span class="st">"full"</span>]]</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  df_filtered <span class="ot">&lt;-</span> df_full <span class="sc">%&gt;%</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">&gt;=</span> start_year) <span class="sc">%&gt;%</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(year)  </span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_filtered)</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we need to divide these new series into a training and a testing set. We will do the split, ensuring that the 80% of the data is used for training.</p>
<p>Now that we have prepared the dataset, we can begin the ARIMAX study.</p>
<section id="spain-1" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="spain-1"><span class="header-section-number">7.1</span> Spain</h3>
<p>We begin studying Spain data. First, let’s plot all three variables (number_deaths, population and gdp_capita) in the same plot.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-115-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We need to further analyze the main characteristics of the three series. We begin assessing the stationary condition using the ADF test:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_spain_train$population
Dickey-Fuller = -3.1341, Lag order = 3, p-value = 0.1194
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_spain_train$gdp_capita
Dickey-Fuller = -1.6919, Lag order = 3, p-value = 0.6979
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>Neither the population nor the GDP per capita series are stationary.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_spain_train$population %&gt;% diff()
Dickey-Fuller = -2.756, Lag order = 3, p-value = 0.2716
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_spain_train$gdp_capita %&gt;% diff()
Dickey-Fuller = -3.0527, Lag order = 3, p-value = 0.1529
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>After a first order difference, series still not stationary. In fact, is not but after three differences that the series get stationary. However, and due to the consequences of high order differences explained in the memory, we are going to analyze both 1 or 2 differences only.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_spain_train$population %&gt;% diff(differences = 3)
Dickey-Fuller = -3.855, Lag order = 3, p-value = 0.02372
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_spain_train$gdp_capita %&gt;% diff()
Dickey-Fuller = -3.0527, Lag order = 3, p-value = 0.1529
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>We plot the ACF and PACF of both approaches, of each series.</p>
<ol type="1">
<li>Population series, first order differences:</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-119-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-119-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Results: The PACF reveals two significant lags at the beginning of the series, with additional spikes at lags 7 and 11. The ACF exhibits a slow decay, suggesting that the series may remain non-stationary after a single differencing.</p>
<ol start="2" type="1">
<li>Population series, two order differences:</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-120-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-120-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Results: The ACF displays prominent spikes at lags 1, 6, and 7. The PACF similarly shows significant spikes at lags 1 and 6, while other lags fall within the confidence bounds. These patterns are more consistent with stationarity.</p>
<ol start="3" type="1">
<li>GDP per capita series, first order differences:</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-121-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-121-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Results: The PACF exhibits significant spikes at lags 1 and 15. The ACF also shows notable autocorrelations at both the first and last lags, suggesting possible seasonality or long-range dependence.</p>
<ol start="4" type="1">
<li>GDP per capita series, two order differences:</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-122-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-122-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Results: The PACF includes a significant negative spike at lag 3, while the rest remain within the confidence bounds. The ACF shows no significant autocorrelations, indicating that the second-order differencing may have adequately removed autocorrelated structure from the series.</p>
<p>We first study which model recomends the auto.arima function</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_spain_short 
Regression with ARIMA(1,1,0) errors 

Coefficients:
          ar1    drift  population  gdp_capita
      -0.5414  -0.0582     -0.4794      0.0004
s.e.   0.1288   0.0153      1.4948      0.0627

sigma^2 = 0.004452:  log likelihood = 65.07
AIC=-120.15   AICc=-118.75   BIC=-110.69

Training set error measures:
                       ME       RMSE        MAE        MPE      MAPE      MASE
Training set 0.0005184054 0.06330152 0.05038494 0.03269338 0.7232606 0.6411973
                    ACF1
Training set -0.01665529</code></pre>
</div>
</div>
<p>The function suggested an ARIMAX(1,1,0), that presents an AIC of <span class="math inline">\(-120\)</span>. Now, to choose the manual ARIMA, we could try the try_all_arima function and study which model presents better AIC value.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>ARIMA(0,1,0)
numeric(0)
AIC: -88.15852 

ARIMA(0,1,1)
       ma1 
0.06433635 
AIC: -86.55553 

ARIMA(0,2,0)
numeric(0)
AIC: -59.57194 

ARIMA(0,2,1)
       ma1 
-0.9692791 
AIC: -103.9146 

ARIMA(1,1,0)
      ar1 
0.1289815 
AIC: -86.96791 

ARIMA(1,1,1)
      ar1       ma1 
 0.998951 -0.964328 
AIC: -104.6931 

ARIMA(1,2,0)
       ar1 
-0.7657822 
AIC: -95.40514 

ARIMA(1,2,1)
       ar1        ma1 
-0.5714757 -0.8988954 
AIC: -117.6681 </code></pre>
</div>
</div>
<p>The model selected is an ARIMA(<span class="math inline">\(1,2,1\)</span>), with an AIC of <span class="math inline">\(-117.66\)</span>. We check the residuals of both models.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_spain_short 
Regression with ARIMA(1,2,1) errors 

Coefficients:
          ar1      ma1  population  gdp_capita
      -0.5800  -0.8957     -0.5114      0.0293
s.e.   0.1275   0.0681      1.5937      0.0638

sigma^2 = 0.004565:  log likelihood = 61.97
AIC=-113.93   AICc=-112.5   BIC=-104.58

Training set error measures:
                      ME       RMSE        MAE        MPE      MAPE      MASE
Training set 0.004438991 0.06337872 0.05050713 0.08319328 0.7237769 0.6427524
                    ACF1
Training set -0.08255464</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-125-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(1,1,0) errors
Q* = 4.1483, df = 9, p-value = 0.9014

Model df: 1.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_auto_arimax_spain)
W = 0.97747, p-value = 0.451</code></pre>
</div>
</div>
<p>The autogenerated model satisfies the assumption on the residuals.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-126-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(1,2,1) errors
Q* = 4.3106, df = 8, p-value = 0.8281

Model df: 2.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_manual_arimax_spain)
W = 0.99405, p-value = 0.9967</code></pre>
</div>
</div>
<p>The manual model, too. Now, we check the accuracy measures:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model         ME     RMSE      MAE      MAPE
1 manualARIMA-h1  -2.686483 32.76437 23.60795  8.749985
2 manualARIMA-h3  -5.434213 28.67536 19.82909  8.240665
3 manualARIMA-h5  -7.659201 38.45264 24.33073 10.190286
4   autoARIMA-h1 -18.205045 34.91302 25.15793  9.793343
5   autoARIMA-h3 -44.286085 53.79319 46.28594 18.793579
6   autoARIMA-h5 -70.538654 80.84287 70.53865 29.744293</code></pre>
</div>
</div>
<p>The manually adjusted model consistently outperforms the automatic one across all error metrics and forecast horizons. In particular, the mean error of the automatic model is notably more negative across all horizons, reflecting a severe overestimation bias. For example, at horizon <span class="math inline">\(h=5\)</span>, the automatic model overpredicts by more than 70 deaths on average, while the manual model maintains a considerably smaller bias of approximately <span class="math inline">\(-7.66\)</span>.</p>
<p>Regarding scale-dependent metrics, such as RMSE and MAE, the manual model achieves significantly lower values—especially at <span class="math inline">\(h=3\)</span> and <span class="math inline">\(h=5\)</span>—indicating more accurate point forecasts. Similarly, MAPE values show that the relative forecast error of the manual model remains below <span class="math inline">\(11%\)</span> at all horizons, compared to nearly <span class="math inline">\(30%\)</span> for the automatic model at <span class="math inline">\(h=5\)</span>.</p>
<p>These results confirm the superiority of the manual ARIMA specification in both accuracy and stability, particularly in medium- and long-term forecasts. Moreover, the progressive deterioration of the automatic model’s accuracy with increasing horizon highlights its limited predictive capacity for multi-step forecasts.</p>
<p>The results can be visualized next:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-128-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-128-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-128-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">calc_exp_bounds</span>(results_arimax_spain, <span class="st">"auto"</span>, <span class="dv">1</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="fu">calc_exp_bounds</span>(results_arimax_spain, <span class="st">"manual"</span>, <span class="dv">1</span>)</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="fu">calc_exp_bounds</span>(results_arimax_spain, <span class="st">"auto"</span>, <span class="dv">2</span>)</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="fu">calc_exp_bounds</span>(results_arimax_spain, <span class="st">"manual"</span>,  <span class="dv">2</span>)</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="fu">calc_exp_bounds</span>(results_arimax_spain, <span class="st">"auto"</span>,  <span class="dv">3</span>)</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a><span class="fu">calc_exp_bounds</span>(results_arimax_spain, <span class="st">"manual"</span>,  <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-netherlands-1" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="the-netherlands-1"><span class="header-section-number">7.2</span> The Netherlands</h3>
<p>Let’s continue with the Netherlands.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-132-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We check the stationarity of the three series:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_netherlands_train$population
Dickey-Fuller = -2.975, Lag order = 3, p-value = 0.1824
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_netherlands_train$gdp_capita
Dickey-Fuller = -1.8635, Lag order = 3, p-value = 0.6292
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>We apply a first order differences in both series:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_netherlands_train$population %&gt;% diff()
Dickey-Fuller = -2.5873, Lag order = 3, p-value = 0.3387
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_netherlands_train$gdp_capita %&gt;% diff()
Dickey-Fuller = -2.7362, Lag order = 3, p-value = 0.279
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>We still not get stationarity. We apply again a difference:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_netherlands_train$population %&gt;% diff(differences = 2)
Dickey-Fuller = -4.1315, Lag order = 3, p-value = 0.01155
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_netherlands_train$gdp_capita %&gt;% diff(differences = 2)
Dickey-Fuller = -3.8721, Lag order = 3, p-value = 0.02247
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>We need two differences to get the series stationary. Let’s check now which model selects the auto.arima function</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_netherlands_short 
Regression with ARIMA(1,1,2) errors 

Coefficients:
          ar1     ma1      ma2  population  gdp_capita
      -0.4747  0.3193  -0.5343     -6.4473      0.2255
s.e.   0.2101  0.2006   0.1247      2.3461      0.1932

sigma^2 = 0.0218:  log likelihood = 27.17
AIC=-42.34   AICc=-40.39   BIC=-30.87

Training set error measures:
                       ME      RMSE       MAE        MPE     MAPE      MASE
Training set -0.005124349 0.1387012 0.1069655 -0.2267392 2.207524 0.8398958
                    ACF1
Training set -0.01441583</code></pre>
</div>
</div>
<p>The selected model is ARIMA(<span class="math inline">\(1,1,2\)</span>), meaning that after a first order difference, the series still has an autorregressive and moving average components. Now, for the manual model, we should check the ACF and PACF plots. We will study the twice-differenced series.</p>
<p>We begin with the population series</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-137-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-137-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ACF (first) shows significant spikes at lags one and three, whereas the PACF (second) displays two significant first lags. We continue woth the GDP per capita series:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-138-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-138-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>GDP per capita series show a different pattern; the PACF (bottom) displays two significant spikes at lags 2 and 3, whereas the ACF (top) presents an only spike at lag 4.</p>
<p>Overall, an ARIMA(<span class="math inline">\(2,2,1\)</span>) is selected.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_netherlands_short 
Regression with ARIMA(2,2,1) errors 

Coefficients:
          ar1      ar2      ma1  population  gdp_capita
      -0.2676  -0.4200  -1.0000     -2.1920      0.1885
s.e.   0.1288   0.1292   0.1235      4.1533      0.1768

sigma^2 = 0.02299:  log likelihood = 22.94
AIC=-33.89   AICc=-31.89   BIC=-22.54

Training set error measures:
                      ME      RMSE       MAE         MPE     MAPE      MASE
Training set 0.004429497 0.1408256 0.1087181 -0.01153454 2.249443 0.8536576
                   ACF1
Training set 0.03703676</code></pre>
</div>
</div>
<p>It gives an AIC of <span class="math inline">\(-33.89\)</span>. Now, we check the residuals of both models. We begin with the auto.arima model:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-140-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(1,1,2) errors
Q* = 3.7468, df = 7, p-value = 0.8084

Model df: 3.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_auto_arimax_netherlands)
W = 0.98069, p-value = 0.5686</code></pre>
</div>
</div>
<p>The automated model satisfy both assumptions on residuals. We now check the manual model:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-141-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(2,2,1) errors
Q* = 4.5198, df = 7, p-value = 0.7183

Model df: 3.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_arimax_netherlands_221)
W = 0.97759, p-value = 0.4423</code></pre>
</div>
</div>
<p>Residual diagnostic of the manual model determines a well-fitted model, too. We begin the forecast step:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model          ME     RMSE      MAE     MAPE
1 manualARIMA-h1 -1.14895476 7.085337 5.760796 20.83010
2 manualARIMA-h3  0.08788589 5.936333 4.509809 15.29093
3 manualARIMA-h5 -0.45064156 3.173676 2.718076 10.14548
4   autoARIMA-h1 -2.88926649 7.987455 6.214546 22.84134
5   autoARIMA-h3 -3.56806673 6.582616 5.571881 20.30210
6   autoARIMA-h5 -5.65041596 7.006105 6.391479 26.02494</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-143-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-143-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-143-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bulgaria-1" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="bulgaria-1"><span class="header-section-number">7.3</span> Bulgaria</h3>
<p>Now, we study the Bulgarian time series. We begin, as in Spain, by studying the regressor variables.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-146-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The autogenerated model is:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_bulgaria_short 
Regression with ARIMA(0,1,0) errors 

Coefficients:
      population  gdp_capita
          0.8672     -0.0987
s.e.      2.2176      0.0761

sigma^2 = 0.01041:  log likelihood = 29.53
AIC=-53.06   AICc=-52.23   BIC=-48.57

Training set error measures:
                      ME       RMSE        MAE        MPE     MAPE      MASE
Training set -0.01640574 0.09742935 0.07310608 -0.3234561 1.314246 0.9224738
                   ACF1
Training set 0.09458781</code></pre>
</div>
</div>
<p>ARIMA(0,1,0) with an AIC of <span class="math inline">\(-53.06\)</span>. We check the characteristics of the series in order to determine the alternative model. We begin assessing the stationary condition using the ADF test:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_bulgaria_train$population
Dickey-Fuller = -3.5556, Lag order = 3, p-value = 0.05179
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_bulgaria_train$gdp_capita
Dickey-Fuller = -1.6692, Lag order = 3, p-value = 0.7012
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>Neither the population nor the GDP per capita series are stationary.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_bulgaria_train$population %&gt;% diff()
Dickey-Fuller = -2.0279, Lag order = 3, p-value = 0.5621
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_bulgaria_train$gdp_capita %&gt;% diff()
Dickey-Fuller = -3.2993, Lag order = 3, p-value = 0.08909
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>After a first order difference, series still not stationary. In fact, is not but after two differences that the series get stationary. We study both analysis to choose whether adding an order of differences ensures a better perfomance of the model rather than only one difference.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_bulgaria_train$population %&gt;% diff(differences = 2)
Dickey-Fuller = -4.2078, Lag order = 3, p-value = 0.01427
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_bulgaria_train$gdp_capita %&gt;% diff(differences = 2)
Dickey-Fuller = -4.0679, Lag order = 3, p-value = 0.01938
alternative hypothesis: stationary</code></pre>
</div>
</div>
<ol type="1">
<li>Population series, first order differences:</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-151-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-151-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Results: The PACF reveals two significant lags at the beginning of the series. The ACF exhibits a slow decay, suggesting that the series may remain non-stationary after a single differencing, as we proved by the ADF test.</p>
<ol start="2" type="1">
<li>Population series, two order differences:</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-152-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-152-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Results: The ACF displays prominent spikes at lags 1, and 4. The PACF similarly shows significant spikes at the first two lags, while other lags fall within the confidence bounds. These patterns are more consistent with stationarity.</p>
<ol start="3" type="1">
<li>GDP per capita series, first order differences:</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-153-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-153-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Results: The PACF does not show any significant lags rather than at 4th lag. The ACF also shows notable autocorrelations in the first lag.</p>
<ol start="4" type="1">
<li>GDP per capita series, two order differences:</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-154-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-154-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Results: The ACF (left) shows oscillating lags, with many significant spikes at lags 1,3,4,7. The PACF includes significant negative spikes at lags 1 and 2, while the rest remain within the confidence bounds.</p>
<p>Overall, the model proposed is an ARIMA(2,1,2).</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_bulgaria_short 
Regression with ARIMA(2,1,2) errors 

Coefficients:
         ar1      ar2      ma1     ma2  population  gdp_capita
      1.1918  -0.6548  -1.3169  1.0000      2.1299     -0.0578
s.e.  0.2051   0.1658   0.1282  0.1316      2.5781      0.0669

sigma^2 = 0.009403:  log likelihood = 31.87
AIC=-49.73   AICc=-45.25   BIC=-39.26

Training set error measures:
                       ME       RMSE        MAE        MPE     MAPE      MASE
Training set -0.006632323 0.08641027 0.06451438 -0.1321055 1.159577 0.8140613
                   ACF1
Training set 0.07762126</code></pre>
</div>
</div>
<p>The model’s AIC is nearly <span class="math inline">\(-49.8\)</span>, a bit bigger than the autogenerated one, but with no big differences. Noe its time of residuals diagnostic.</p>
<p>We first check the automated one:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-156-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(0,1,0) errors
Q* = 5.5106, df = 7, p-value = 0.5979

Model df: 0.   Total lags used: 7</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_arimax_bulgaria)
W = 0.98179, p-value = 0.8272</code></pre>
</div>
</div>
<p>The residuals of the ARIMAX model satisfy both normality and non autocorrelation hypothesis. We check the manual model:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-157-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(2,1,2) errors
Q* = 5.3595, df = 3, p-value = 0.1473

Model df: 4.   Total lags used: 7</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_arimax_bulgaria_212)
W = 0.97532, p-value = 0.6217</code></pre>
</div>
</div>
<p>Residuals satisfy the assumptions. We then compare the accuracy metrics on both models:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model        ME     RMSE      MAE     MAPE
1 manualARIMA-h1  -7.78128 15.16590 13.42951 15.35036
2 manualARIMA-h3 -15.57614 21.40792 15.57614 19.11546
3 manualARIMA-h5 -29.68002 35.47732 29.68002 41.13675
4   autoARIMA-h1 -10.27709 15.45240 13.11487 15.38396
5   autoARIMA-h3 -21.68342 24.42421 21.68342 27.17859
6   autoARIMA-h5 -35.86438 38.07537 35.86438 49.35258</code></pre>
</div>
</div>
<p>Across all forecast horizons, the manually specified ARIMA model showed smaller errors and less systematic bias than the models selected automatically by the auto.arima() procedure. Negative mean error values in every model indicate a tendency to under-forecast tuberculosis deaths, but the magnitude of this bias was consistently lower for the manual models. Forecast dispersion increased with horizon, as expected, yet the manual ARIMA retained lower RMSE and MAE at each step. Critically, percentage-scaled accuracy (MAPE) remained &lt; 20 % for the manual model up to three steps ahead (15.3 % → 19.1 %), whereas the automated model crossed widely used acceptability thresholds (15.4 % → 27.2 % → 49.4 %).</p>
<p>We finally check the plots of the results:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-159-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-159-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-159-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notably, as the horizon increases, the predictions do not fit well with the observed values; however, and markedly enough, at three-step-ahead forecast, the manual model has capture the spike in 2019 quite good, even better than the one-step-ahead forecast.</p>
</section>
<section id="estonia-1" class="level3" data-number="7.4">
<h3 data-number="7.4" class="anchored" data-anchor-id="estonia-1"><span class="header-section-number">7.4</span> Estonia</h3>
<p>Let’s begin the study for Estonia data. Remember that Estonia is the country that has shorter time series.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-163-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It is clear that the series are not stationary. To further asses this, we use the ADF test:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_estonia_train$population
Dickey-Fuller = -0.93117, Lag order = 2, p-value = 0.9307
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_estonia_train$gdp_capita
Dickey-Fuller = -1.0589, Lag order = 2, p-value = 0.9119
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>We try the first differences:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_estonia_train$population %&gt;% diff()
Dickey-Fuller = -4.1139, Lag order = 2, p-value = 0.01928
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_estonia_train$gdp_capita %&gt;% diff()
Dickey-Fuller = -1.8177, Lag order = 2, p-value = 0.6418
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>The population time series passes the stationarity test after a first difference being applied. In contrast, the GDP per capita time series need more than two differences to get stationary.</p>
<p>We check the first-order difference ACF and PACF plots:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-166-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-166-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The results of the population’s ACF and PACF plots suggest an AR(1) behaviour. We now check the GDP per capita time series:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-167-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-167-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>No signficant spikes are shown in the ACF and PACF plots. Let’s investigate which is the selected ARIMA model of the auto.arima function:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_estonia_short 
Regression with ARIMA(1,1,0) errors 

Coefficients:
          ar1    drift  population  gdp_capita
      -0.5061  -0.1561    -13.4526      0.1165
s.e.   0.2008   0.0374      9.3304      0.4341

sigma^2 = 0.0421:  log likelihood = 6.4
AIC=-2.81   AICc=0.72   BIC=2.87

Training set error measures:
                     ME      RMSE       MAE       MPE     MAPE      MASE
Training set 0.01121661 0.1825569 0.1313415 0.2037424 3.266069 0.7754926
                    ACF1
Training set -0.07426875</code></pre>
</div>
</div>
<p>The auto.arima has selected the ARIMA(1,1,0) as the model with the AIC coefficient minimized (<span class="math inline">\(-2.81\)</span>). This selection fully coincides with the results of the ACF and PACF, so we need to investigate a bit more to choose an alternative model.</p>
<p>Recall that Estonia’s TB-deaths series was not stationary after two differences being applied. We can study the ACF and PACF of the covariates after two differences.</p>
<p>First, the populations series:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-169-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-169-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Then, the GDP per capita time series:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-170-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-170-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We propose an ARIMA(1,2,2) and check the results. First, the AIC returned is:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_estonia_short 
Regression with ARIMA(1,2,2) errors 

Coefficients:
          ar1      ma1     ma2  population  gdp_capita
      -0.1866  -1.9709  0.9996    -13.8269     -0.1731
s.e.   0.2426   0.2044  0.2038      2.5278      0.1225

sigma^2 = 0.03162:  log likelihood = 6.85
AIC=-1.71   AICc=3.89   BIC=4.84

Training set error measures:
                      ME      RMSE       MAE        MPE     MAPE      MASE
Training set -0.02505566 0.1496641 0.1208129 -0.5381029 2.958211 0.7133276
                    ACF1
Training set -0.09727469</code></pre>
</div>
</div>
<p>We check the residuals of both models.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-172-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(1,1,0) errors
Q* = 4.2723, df = 4, p-value = 0.3704

Model df: 1.   Total lags used: 5</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_autoarimax_estonia)
W = 0.91241, p-value = 0.0398</code></pre>
</div>
</div>
<p>The residuals of the automated model do not satisfy the normality assumption.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-173-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(1,2,2) errors
Q* = 4.5637, df = 3, p-value = 0.2067

Model df: 3.   Total lags used: 6</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_arimax_estonia_122)
W = 0.98869, p-value = 0.9922</code></pre>
</div>
</div>
<p>In contrast, the manually selected model satisfy both hypothesis. We can check the accuracy metrics of both models:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model         ME      RMSE       MAE      MAPE
1 manualARIMA-h1   2.432324  4.092794  3.762144  26.39800
2 manualARIMA-h3   2.781070  3.877479  3.724434  30.02106
3 manualARIMA-h5   4.675538  4.689740  4.675538  38.98024
4   autoARIMA-h1  -2.312921  5.272724  3.970093  32.53299
5   autoARIMA-h3  -6.734968  8.812398  6.734968  61.86120
6   autoARIMA-h5 -12.409845 12.410295 12.409845 104.21249</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-175-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-175-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-175-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sweden-1" class="level3" data-number="7.5">
<h3 data-number="7.5" class="anchored" data-anchor-id="sweden-1"><span class="header-section-number">7.5</span> Sweden</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-179-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We check the stationarity of the covariates.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_sweden_train$population
Dickey-Fuller = -4.942, Lag order = 3, p-value = 0.01
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_sweden_train$gdp_capita %&gt;% diff(differences = 2)
Dickey-Fuller = -3.9517, Lag order = 3, p-value = 0.01912
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>The GDP per capita series need to order differences to get stationary; on the contrary, the population series seems to be stationary without any difference. The KPPS test reveals that it is not stationary:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    KPSS Test for Level Stationarity

data:  xreg_sweden_train$population
KPSS Level = 1.3466, Truncation lag parameter = 3, p-value = 0.01</code></pre>
</div>
</div>
<p>Now, we check the ACF and PACF of both first and two differences:</p>
<ol type="1">
<li>First difference of population series</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-182-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-182-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It is clear that the series is not stationary, and the slow decay of the ACF confirms the hypothesis.</p>
<ol start="2" type="1">
<li>Second difference of population series</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-183-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-183-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>After two differences, the ACF (top) shows a significant spike at the first lag, whereas the PACF (bottom) displays three signficant spikes at the first three lags.</p>
<ol start="3" type="1">
<li>First difference of population series</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-184-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-184-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>No autocorrelation is shown in the ACF (top) and in the PACF (bottom) only at lag 5.</p>
<ol start="4" type="1">
<li>Second difference of population series</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-185-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-185-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ACF (top) displays significant spikes at lags 4, 8 and 16, whereas the PACF (bottom) displays an only significant spike at lag 3.</p>
<p>Overall, the manual selected model is ARIMA(<span class="math inline">\(2,1,2\)</span>).</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_sweden_short 
Regression with ARIMA(2,1,2) errors 

Coefficients:
          ar1      ar2     ma1     ma2  population  gdp_capita
      -0.4220  -0.9131  0.3112  0.7891     -6.7746     -0.0901
s.e.   0.1763   0.1261  0.2208  0.1957      4.6835      0.2063

sigma^2 = 0.03126:  log likelihood = 18.83
AIC=-23.66   AICc=-20.99   BIC=-10.27

Training set error measures:
                      ME      RMSE       MAE        MPE     MAPE      MASE
Training set -0.01904322 0.1642148 0.1223558 -0.5045827 2.588142 0.9522946
                    ACF1
Training set -0.06876438</code></pre>
</div>
</div>
<p>Now, we check the auto.arima function selected model:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_sweden_short 
Regression with ARIMA(2,1,0) errors 

Coefficients:
          ar1      ar2    drift  population  gdp_capita
      -0.3742  -0.2828  -0.0920      7.8018      0.0794
s.e.   0.1594   0.1574   0.0552      9.0284      0.2616

sigma^2 = 0.02865:  log likelihood = 20.64
AIC=-29.28   AICc=-27.33   BIC=-17.81

Training set error measures:
                       ME      RMSE       MAE        MPE     MAPE      MASE
Training set -0.004061642 0.1590008 0.1240047 -0.1744745 2.628186 0.9651276
                    ACF1
Training set -0.02919613</code></pre>
</div>
</div>
<p>The model selected is ARIMA(<span class="math inline">\(2,1,0\)</span>). Now we check the residuals of both models. We begin with the automatic model:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-188-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(2,1,0) errors
Q* = 7.9121, df = 8, p-value = 0.4421

Model df: 2.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_arimax_sweden_auto)
W = 0.96504, p-value = 0.1368</code></pre>
</div>
</div>
<p>The residuals of the auto.arima model satisfy both assumptions. Now, we check the residuals of the ARIMA(<span class="math inline">\(1,2,2\)</span>):</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-189-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(2,1,2) errors
Q* = 8.6978, df = 6, p-value = 0.1913

Model df: 4.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_arimax_sweden_212)
W = 0.9628, p-value = 0.1098</code></pre>
</div>
</div>
<p>The residuals of the ARIMAX model satisfy the assumptions. Now, we begin the forecast:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model         ME     RMSE      MAE     MAPE
1 manualARIMA-h1  0.7403164 6.305785 4.926170 17.32592
2 manualARIMA-h3 -0.8629153 6.080243 5.135321 21.20053
3 manualARIMA-h5 -2.6754165 5.276789 4.698172 22.84022
4   autoARIMA-h1  0.3584965 5.506936 4.512621 17.16023
5   autoARIMA-h3 -1.3901445 6.199075 5.290426 22.02628
6   autoARIMA-h5 -3.2374791 5.649563 5.151597 24.62736</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-191-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-191-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-191-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="switzerland-1" class="level3" data-number="7.6">
<h3 data-number="7.6" class="anchored" data-anchor-id="switzerland-1"><span class="header-section-number">7.6</span> Switzerland</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-194-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We check the stationarity of the covariates:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_switzerland_train$population
Dickey-Fuller = -2.8213, Lag order = 3, p-value = 0.2448
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_switzerland_train$gdp_capita
Dickey-Fuller = -1.1687, Lag order = 3, p-value = 0.903
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>The series are clearly non-stationary. We apply a first order differences:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_switzerland_train$population %&gt;% diff()
Dickey-Fuller = -2.5748, Lag order = 3, p-value = 0.3442
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_switzerland_train$gdp_capita %&gt;% diff()
Dickey-Fuller = -2.7258, Lag order = 3, p-value = 0.2837
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>We apply a second order differences:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_switzerland_train$population %&gt;% diff(differences = 2)
Dickey-Fuller = -3.7731, Lag order = 3, p-value = 0.02867
alternative hypothesis: stationary</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Augmented Dickey-Fuller Test

data:  xreg_switzerland_train$gdp_capita %&gt;% diff(differences = 2)
Dickey-Fuller = -4.349, Lag order = 3, p-value = 0.01
alternative hypothesis: stationary</code></pre>
</div>
</div>
<p>The series get stationary after two differences. We check the auto.arima suggested model:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_switzerland_short 
Regression with ARIMA(1,0,0) errors 

Coefficients:
         ar1  intercept  population  gdp_capita
      0.8137   111.4201     -6.6318     -0.2545
s.e.  0.1158    30.9481      2.0773      0.2098

sigma^2 = 0.02836:  log likelihood = 19.67
AIC=-29.33   AICc=-27.97   BIC=-19.77

Training set error measures:
                      ME      RMSE       MAE        MPE     MAPE     MASE
Training set 0.006919642 0.1615247 0.1264871 -0.1039094 2.763029 1.017363
                      ACF1
Training set -0.0003515405</code></pre>
</div>
</div>
<p>The procedure suggested an ARIMA(<span class="math inline">\(1,0,0\)</span>), meaning no differences are applied (recall that the ADF test of the main series show that the series is stationary without any differences).</p>
<p>Now, let’s check the ACF and PACF plots of the covariates after one and two differences:</p>
<ol type="1">
<li>First difference of population series</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-199-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-199-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It is clear that the series is not stationary, and the slow decay of the ACF confirms the hypothesis.</p>
<ol start="2" type="1">
<li>Second difference of population series</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-200-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-200-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>After two differences, the ACF (top) shows a significant spike at the first lag, whereas the PACF (bottom) displays two signficant spikes at the first two lags.</p>
<ol start="3" type="1">
<li>First difference of population series</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-201-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-201-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>No autocorrelation is shown in the PACF (bottom) and in the ACF (top) only at lag 1.</p>
<ol start="4" type="1">
<li>Second difference of population series</li>
</ol>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-202-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-202-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The ACF (top) shows significant spikes at lags 4 and 8, whereas the PACF shows negative spikes at lags 2 and 7. Overall, the fitted model is ARIMA(<span class="math inline">\(2,2,1\)</span>).</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Series: train_switzerland_short 
Regression with ARIMA(2,2,1) errors 

Coefficients:
          ar1      ar2      ma1  population  gdp_capita
      -0.1512  -0.0977  -1.0000      3.5259       0.168
s.e.   0.1517   0.1469   0.0603      3.2656       0.211

sigma^2 = 0.02556:  log likelihood = 20.46
AIC=-28.91   AICc=-26.87   BIC=-17.69

Training set error measures:
                     ME      RMSE       MAE       MPE     MAPE      MASE
Training set 0.01257164 0.1482632 0.1081355 0.2099184 2.453913 0.8697569
                   ACF1
Training set -0.0347773</code></pre>
</div>
</div>
<p>Now, we check the residuals of both models:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-204-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(1,0,0) errors
Q* = 5.3586, df = 9, p-value = 0.802

Model df: 1.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_autoarimax_switzerland)
W = 0.95885, p-value = 0.07958</code></pre>
</div>
</div>
<p>The residuals of the auto.arima ARIMAX model do not satisfy the normality hypothesis. Now we check the ARIMA(2,2,1):</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-205-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from Regression with ARIMA(2,2,1) errors
Q* = 9.9178, df = 7, p-value = 0.1933

Model df: 3.   Total lags used: 10</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(fit_arimax_switzerland_221)
W = 0.9113, p-value = 0.00116</code></pre>
</div>
</div>
<p>The residuals of the manual model do not distribute normally neither. Now we begin the forecast step:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           Model          ME     RMSE      MAE     MAPE
1 manualARIMA-h1  0.54448761 6.300541 5.033113 35.07290
2 manualARIMA-h3  0.01233386 6.430613 5.278300 35.45111
3 manualARIMA-h5  1.04031338 5.459486 4.056825 23.64684
4   autoARIMA-h1  0.36671533 6.070042 4.843401 34.69953
5   autoARIMA-h3 -0.03282070 6.097291 4.898087 34.44299
6   autoARIMA-h5  0.62144902 4.855050 3.545548 21.53827</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$h1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-207-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h3</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-207-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$h5</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="TFG_files/figure-html/unnamed-chunk-207-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>